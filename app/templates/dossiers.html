{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="container py-4 px-4 rounded shadow-sm" style="background-color: #e8f5e9;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-success"><i class="bi bi-folder2-open"></i> Gestion des Dossiers</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-success shadow" data-bs-toggle="modal" data-bs-target="#ajoutDossierModal">
          <i class="bi bi-plus-circle"></i> Ajouter un dossier
        </button>
        <a href="{{ url_for('documents') }}" class="btn btn-outline-primary">
          <i class="bi bi-paperclip"></i> Ajouter un document
        </a>
      </div>
    </div>

    <table id="dossiersTable" class="table table-bordered table-hover rounded shadow w-100 overflow-hidden" style="background-color:#ffffff;">
      <thead class="table-success text-dark">
        <tr>
          <th></th>
          <th>ID Dossier</th>
          <th>Nature du dossier</th>
          <th>Client</th>
          <th>Date d'ouverture</th>
          <th class="wrap">Procédures</th>
          <th>Référent</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for dossier in dossiers %}
        <tr class="dossier-row"
            data-id="{{ dossier.id }}"
            data-numero="{{ dossier.numero }}"
            data-nom="{{ dossier.nom }}"
            data-client="{{ dossier.client.societe }}"
            data-date="{{ dossier.date_ouverture.strftime('%d/%m/%Y') }}"
            data-procedure="{{ dossier.procedure }}"
            data-referent="{{ dossier.referent.nom if dossier.referent else 'Non attribué' }}"
            data-statut="{{ dossier.statut }}"
            data-description="{{ dossier.description }}">
          <td></td> 
          <td>{{ dossier.numero }}</td>
          <td>{{ dossier.nom }}</td>
          <td>{{ dossier.client.societe }}</td>
          <td>{{ dossier.date_ouverture.strftime('%d/%m/%Y') }}</td>
          <td class="wrap">{{ dossier.procedures or '—' }}</td>
          <td>
            {% if dossier.referent %}
              {{ dossier.referent.nom }}
            {% else %}
              <span class="text-muted">Non attribué</span>
            {% endif %}
          </td>
          <td>
            {% if dossier.statut == 'En cours' %}
              <span class="badge bg-warning text-dark">⏳ En cours</span>
            {% elif dossier.statut == 'Terminé' %}
              <span class="badge bg-success">✔️ Terminé</span>
            {% else %}
              <span class="badge bg-secondary">{{ dossier.statut }}</span>
            {% endif %}
          </td>
          
          <td>
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#histModal-{{ dossier.id }}">
              Historique
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# Menu contextuel #}
<div id="context-menu" class="shadow rounded" style="display:none; position:absolute; z-index:9999; background-color:#fff; border:1px solid #ccc; padding:5px;">
  <ul class="list-unstyled m-0">
    <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
    <li><a href="#" id="exportPDF" class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
    <li><a href="#" id="printTable" class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
  </ul>
</div>

{# Modale d’ajout dossier #}
<div class="modal fade" id="ajoutDossierModal" tabindex="-1" aria-labelledby="ajoutDossierLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('dossiers') }}">
        {{ form.hidden_tag() }}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="ajoutDossierLabel">Ajouter un dossier</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">{{ form.numero.label(class="form-label") }}{{ form.numero(class="form-control" + (" is-invalid" if form.numero.errors else "")) }}
            {% if form.numero.errors %}
              <div class="invalid-feedback">
                {{ form.numero.errors[0] }}
              </div>
            {% endif %}
          </div>
          <div class="col-md-6">{{ form.nom.label(class="form-label") }}{{ form.nom(class="form-control") }}</div>
          <div class="col-md-6">{{ form.date_ouverture.label(class="form-label") }}{{ form.date_ouverture(class="form-control") }}</div>
          <div class="col-md-6">{{ form.procedures.label(class="form-label") }}{{ form.procedures(class="form-control") }}{% if form.procedures.errors %}
          <div class="invalid-feedback d-block">{{ form.procedures.errors[0] }}{% endif %}</div>
          <div class="col-md-6">{{ form.statut.label(class="form-label") }}{{ form.statut(class="form-select") }}</div>
          <div class="col-md-6">{{ form.client_id.label(class="form-label") }}{{ form.client_id(class="form-select select2-ajax") }}</div>
          <div class="mb-3">
            <label for="user_id" class="form-label">Attribuer à</label>
            {{ form.user_id(class="form-select") }}
          </div>
          <div class="col-md-12">{{ form.description.label(class="form-label") }}{{ form.description(class="form-control", rows="2") }}</div>
        </div>
        <div class="modal-footer">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

{# Modale DÉTAIL dossier (ouverte au double-clic) #}
<div class="modal fade" id="detailDossierModal" tabindex="-1" aria-labelledby="detailDossierLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Détail du Dossier</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body row g-3">
      <div class="col-md-6">
        <div class="card shadow-sm border-light h-100">
          <div class="card-body">
            <h6 class="card-title text-primary"><i class="bi bi-info-circle me-2"></i>Informations Principales</h6>
            <hr>
            <p><strong>ID Dossier :</strong> <span id="detail-numero"></span></p>
            <p><strong>Nature :</strong> <span id="detail-nom"></span></p>
            <p><strong>Client :</strong> <span id="detail-client"></span></p>
            <p><strong>Date d'ouverture :</strong> <span id="detail-date"></span></p>
            <p><strong>Procédures :</strong> <span id="detail-procedure"></span></p>
            <p><strong>Référent :</strong> <span id="detail-referent"></span></p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm border-light h-100">
          <div class="card-body">
            <h6 class="card-title text-primary"><i class="bi bi-bar-chart-line me-2"></i>Statut</h6>
            <hr>
            <p><strong>Statut :</strong> <span id="detail-statut"></span></p>
            <p class="text-muted small mt-3"><i class="bi bi-exclamation-circle me-1"></i>Le statut indique l'avancement du dossier.</p>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card shadow-sm border-light">
          <div class="card-body">
            <h6 class="card-title text-primary"><i class="bi bi-text-left me-2"></i>Description Détaillée</h6>
            <hr>
            <p id="detail-description" class="text-muted fst-italic"></p>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <a id="editDossierLink" class="btn btn-outline-primary">Modifier</a>
      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
    </div>
  </div></div>
</div>

{# === Modales HISTORIQUE (hors du tableau), une par dossier === #}
{% for dossier in dossiers %}
<div class="modal fade" id="histModal-{{ dossier.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-light">
      <h5 class="modal-title">Historique d'attribution — {{ dossier.numero or dossier.id }}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      {% set hist = hist_map.get(dossier.id, []) %}
      {% if hist %}
        <ul class="list-group">
        {% for h in hist %}
          <li class="list-group-item">
            <div class="fw-semibold">
              {{ h.date_attribution.strftime('%d/%m/%Y %H:%M') }}
              — par {{ h.auteur.nom if h.auteur else 'N/A' }}
            </div>
            <div>
              De <em>{{ h.ancien_referent.nom if h.ancien_referent else '—' }}</em>
              à <strong>{{ h.nouveau_referent.nom if h.nouveau_referent else 'N/A' }}</strong>
            </div>
            {% if h.motif %}<div class="text-muted small mt-1">Motif : {{ h.motif }}</div>{% endif %}
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted fst-italic">Aucun historique d’attribution pour ce dossier.</p>
      {% endif %}
    </div>
  </div></div>
</div>
{% endfor %}

{# Modale confirmation suppression #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm"><div class="modal-content">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
      <button type="button" class="btn btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
    </div>
    <div class="modal-body">
      Êtes-vous sûr de vouloir supprimer ce dossier ? Cette action est irréversible.
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      <form id="deleteDossierForm" method="POST" style="display:inline;">
        {{ delete_form.hidden_tag() }}
        <button type="submit" class="btn btn-danger">Supprimer</button>
      </form>
    </div>
  </div></div>
</div>
{% endblock %}

{% block scripts %}
<!-- CSS Buttons + Select -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">

<!-- Dépendances export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<!-- DataTables Buttons + Select -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

{% if form.errors %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const modal = document.getElementById('ajoutDossierModal');
  if (modal && window.bootstrap?.Modal) new bootstrap.Modal(modal).show();
});
</script>
{% endif %}

<script>
$(function () {
  // ========= Références =========
  const tableEl = '#dossiersTable';
  const $table  = $(tableEl);

  // ========= DataTable =========
  const dt = $table.DataTable({
    responsive: true,
    autoWidth: false,
    dom: 'Bfrtip',
    // Sélection UNIQUEMENT via la 1ère colonne "checkbox"
    select: { style: 'multi', selector: 'td.select-checkbox' },
    columnDefs: [
      { // Colonne 0 = cases de sélection visuelles
        targets: 0,
        orderable: false,
        className: 'select-checkbox no-export',
        defaultContent: ''
      }
    ],
    order: [[1, 'asc']], // trie par la 1re vraie colonne de données
    buttons: [
      {
        extend: 'excelHtml5',
        text: '<i class="bi bi-file-earmark-excel"></i> Exporter Excel ',
        filename: 'dossiers_selection',
        exportOptions: {
          modifier: { selected: true },
          columns: ':visible:not(.no-export)'
        }
      },
      {
        extend: 'pdfHtml5',
        text: '<i class="bi bi-file-pdf"></i> Exporter PDF ',
        filename: 'dossiers_selection',
        orientation: 'landscape',
        pageSize: 'A4',
        exportOptions: {
          modifier: { selected: true },
          columns: ':visible:not(.no-export)'
        }
      },
      {
        extend: 'print',
        text: '<i class="bi bi-printer"></i> Imprimer ',
        exportOptions: {
          modifier: { selected: true },
          columns: ':visible:not(.no-export)'
        }
      }
    ],
    language: {
      select: { rows: { _: "%d lignes sélectionnées", 0: "", 1: "1 ligne sélectionnée" } }
    }
  });

  // ========= Utils =========
  function parentRowFromCell(cell) {
    let $tr = $(cell).closest('tr');
    if ($tr.hasClass('child')) $tr = $tr.prev('tr'); // responsive
    return $tr;
  }

  function openDetailFromRow($tr) {
    const el = $tr.get(0);
    if (!el) return;

    const tds = $tr.find('td');
    const off = tds.eq(0).hasClass('select-checkbox') ? 1 : 0; // décalage si col. sélection

    const numero    = el.dataset.numero    || (tds.eq(0+off).text().trim());
    const nom       = el.dataset.nom       || (tds.eq(1+off).text().trim());
    const client    = el.dataset.client    || (tds.eq(2+off).text().trim());
    const date      = el.dataset.date      || (tds.eq(3+off).text().trim());
    const procedure = el.dataset.procedure || (tds.eq(4+off).text().trim());
    const referent  = el.dataset.referent  || (tds.eq(5+off).text().trim());
    const statut    = el.dataset.statut    || (tds.eq(6+off).text().trim());
    const descr     = el.dataset.description || '';

    $('#detail-numero').text(numero);
    $('#detail-nom').text(nom);
    $('#detail-client').text(client);
    $('#detail-date').text(date);
    $('#detail-procedure').text(procedure);
    $('#detail-referent').text(referent);
    $('#detail-description').text(descr);

    const id = el.dataset.id;
    if (id) {
      $('#editDossierLink').attr('href', '/dossiers/modifier/' + id);
      $('#deleteDossierForm').attr('action', '/dossiers/supprimer/' + id);
    }

    const badge = (statut === 'En cours')
      ? '<span class="badge bg-warning text-dark">⏳ En cours</span>'
      : (statut === 'Terminé')
        ? '<span class="badge bg-success">✔️ Terminé</span>'
        : `<span class="badge bg-secondary">${statut}</span>`;
    $('#detail-statut').html(badge);

    const modalEl = document.getElementById('detailDossierModal');
    if (modalEl) new bootstrap.Modal(modalEl).show();
  }

  // Ne pas ouvrir le détail depuis les contrôles (dont la colonne select)
  function isControl(target) {
    return $(target).closest('button,[data-bs-toggle],a,input,label,.dt-button,.select-checkbox').length > 0;
  }

  // Empêcher la ligne d’ouvrir la modale en cliquant sur “Historique”
  $table.on('click', 'button[data-bs-target^="#histModal-"]', function (e) {
    e.stopPropagation();
  });

  // ========= Double-clic uniquement pour le détail =========
  let clickTimer = null; // (garde si tu veux réactiver un fallback plus tard)
  $table.on('dblclick', 'tbody td:not(.select-checkbox)', function (e) {
    if (isControl(e.target)) return; // sécurité
    const $tr = parentRowFromCell(this);
    openDetailFromRow($tr);
  });

  // ========= Menu contextuel =========
  $table.on('contextmenu', 'tbody tr', function (e) {
    e.preventDefault();
    $('#context-menu').css({ top: e.pageY + 'px', left: e.pageX + 'px' }).show();
  });
  $(document).on('click', () => $('#context-menu').hide());

  // ========= Curseur pointeur =========
  $('<style>#dossiersTable tbody tr{cursor:pointer}</style>').appendTo(document.head);

  // ========= Mode compact =========
  (function compactDossiersTable() {
    const css = `
      #dossiersTable.compact tbody td{ font-size:12px!important; padding:4px 6px!important; line-height:1.1!important; white-space:nowrap; }
      #dossiersTable.compact .badge{ font-size:10px!important; padding:.15rem .35rem!important; }
      #dossiersTable.compact thead th{ font-size:10px!important; padding:3px 6px!important; line-height:1.05!important; vertical-align:middle!important; white-space:nowrap!important; }
      #dossiersTable.dataTable thead th.sorting, #dossiersTable.dataTable thead th.sorting_asc, #dossiersTable.dataTable thead th.sorting_desc{ padding-right:14px!important; background-size:9px 9px!important; background-position:right 4px center!important; }
      #dossiersTable thead .sorting:before, #dossiersTable thead .sorting_asc:before, #dossiersTable thead .sorting_desc:before,
      #dossiersTable thead .sorting:after,  #dossiersTable thead .sorting_asc:after,  #dossiersTable thead .sorting_desc:after{ font-size:.6rem!important; right:.25rem!important; }
      #dossiersTable.compact .wrap{ white-space:normal!important; max-width:260px; }
    `;
    if (!document.getElementById('dossiers-compact-css')) {
      const style = document.createElement('style');
      style.id = 'dossiers-compact-css';
      style.textContent = css;
      document.head.appendChild(style);
    }
    const tbl = document.getElementById('dossiersTable');
    if (tbl) tbl.classList.add('compact');
    try { setTimeout(() => dt.columns.adjust().draw(false), 0); } catch(e) {}
  })();
});
</script>
{% endblock %}
