{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="container py-4 px-4 rounded shadow-sm" style="background-color: #e8f5e9;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-success"><i class="bi bi-folder2-open"></i> Gestion des Dossiers</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-success shadow" data-bs-toggle="modal" data-bs-target="#ajoutDossierModal">
          <i class="bi bi-plus-circle"></i> Ajouter un dossier
        </button>
        <a href="{{ url_for('documents') }}" class="btn btn-outline-primary">
          <i class="bi bi-paperclip"></i> Ajouter un document
        </a>
      </div>
    </div>

    <table id="dossiersTable" class="table table-bordered table-hover rounded shadow w-100 overflow-hidden" style="background-color:#ffffff;">
      <thead class="table-success text-dark">
        <tr>
          <th>ID Dossier</th>
          <th>Nature du dossier</th>
          <th>Client</th>
          <th>Date d'ouverture</th>
          <th class="wrap">Procédures</th>
          <th>Référent</th>
          <th>Statut</th>
          <th class="wrap">Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for dossier in dossiers %}
        <tr class="dossier-row"
            data-id="{{ dossier.id }}"
            data-numero="{{ dossier.numero }}"
            data-nom="{{ dossier.nom }}"
            data-client="{{ dossier.client.societe }}"
            data-date="{{ dossier.date_ouverture.strftime('%d/%m/%Y') }}"
            data-procedure="{{ dossier.procedure }}"
            data-referent="{{ dossier.referent.nom if dossier.referent else 'Non attribué' }}"
            data-statut="{{ dossier.statut }}"
            data-description="{{ dossier.description }}">
          <td>{{ dossier.numero }}</td>
          <td>{{ dossier.nom }}</td>
          <td>{{ dossier.client.societe }}</td>
          <td>{{ dossier.date_ouverture.strftime('%d/%m/%Y') }}</td>
          <td class="wrap">{{ dossier.procedures or '—' }}</td>
          <td>
            {% if dossier.referent %}
              {{ dossier.referent.nom }}
            {% else %}
              <span class="text-muted">Non attribué</span>
            {% endif %}
          </td>
          <td>
            {% if dossier.statut == 'En cours' %}
              <span class="badge bg-warning text-dark">⏳ En cours</span>
            {% elif dossier.statut == 'Terminé' %}
              <span class="badge bg-success">✔️ Terminé</span>
            {% else %}
              <span class="badge bg-secondary">{{ dossier.statut }}</span>
            {% endif %}
          </td>
          <td class="wrap" style="max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
            {{ dossier.description }}
          </td>
          <td>
            <button type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#histModal-{{ dossier.id }}">
              Historique
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# Menu contextuel #}
<div id="context-menu" class="shadow rounded" style="display:none; position:absolute; z-index:9999; background-color:#fff; border:1px solid #ccc; padding:5px;">
  <ul class="list-unstyled m-0">
    <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
    <li><a href="#" id="exportPDF" class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
    <li><a href="#" id="printTable" class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
  </ul>
</div>

{# Modale d’ajout dossier #}
<div class="modal fade" id="ajoutDossierModal" tabindex="-1" aria-labelledby="ajoutDossierLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('dossiers') }}">
        {{ form.hidden_tag() }}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="ajoutDossierLabel">Ajouter un dossier</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">{{ form.numero.label(class="form-label") }}{{ form.numero(class="form-control") }}</div>
          <div class="col-md-6">{{ form.nom.label(class="form-label") }}{{ form.nom(class="form-control") }}</div>
          <div class="col-md-6">{{ form.date_ouverture.label(class="form-label") }}{{ form.date_ouverture(class="form-control") }}</div>
          <div class="col-md-6">{{ form.procedures.label(class="form-label") }}{{ form.procedures(class="form-control") }}{% if form.procedures.errors %}
          <div class="invalid-feedback d-block">{{ form.procedures.errors[0] }}{% endif %}</div>
          <div class="col-md-6">{{ form.statut.label(class="form-label") }}{{ form.statut(class="form-select") }}</div>
          <div class="col-md-6">{{ form.client_id.label(class="form-label") }}{{ form.client_id(class="form-select select2-ajax") }}</div>
          <div class="mb-3">
            <label for="user_id" class="form-label">Attribuer à</label>
            {{ form.user_id(class="form-select") }}
          </div>
          <div class="col-md-12">{{ form.description.label(class="form-label") }}{{ form.description(class="form-control", rows="2") }}</div>
        </div>
        <div class="modal-footer">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

{# Modale DÉTAIL dossier (ouverte au double-clic) #}
<div class="modal fade" id="detailDossierModal" tabindex="-1" aria-labelledby="detailDossierLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Détail du Dossier</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body row g-3">
      <div class="col-md-6">
        <div class="card shadow-sm border-light h-100">
          <div class="card-body">
            <h6 class="card-title text-primary"><i class="bi bi-info-circle me-2"></i>Informations Principales</h6>
            <hr>
            <p><strong>ID Dossier :</strong> <span id="detail-numero"></span></p>
            <p><strong>Nature :</strong> <span id="detail-nom"></span></p>
            <p><strong>Client :</strong> <span id="detail-client"></span></p>
            <p><strong>Date d'ouverture :</strong> <span id="detail-date"></span></p>
            <p><strong>Procédures :</strong> <span id="detail-procedure"></span></p>
            <p><strong>Référent :</strong> <span id="detail-referent"></span></p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm border-light h-100">
          <div class="card-body">
            <h6 class="card-title text-primary"><i class="bi bi-bar-chart-line me-2"></i>Statut</h6>
            <hr>
            <p><strong>Statut :</strong> <span id="detail-statut"></span></p>
            <p class="text-muted small mt-3"><i class="bi bi-exclamation-circle me-1"></i>Le statut indique l'avancement du dossier.</p>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card shadow-sm border-light">
          <div class="card-body">
            <h6 class="card-title text-primary"><i class="bi bi-text-left me-2"></i>Description Détaillée</h6>
            <hr>
            <p id="detail-description" class="text-muted fst-italic"></p>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <a id="editDossierLink" class="btn btn-outline-primary">Modifier</a>
      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
    </div>
  </div></div>
</div>

{# === Modales HISTORIQUE (hors du tableau), une par dossier === #}
{% for dossier in dossiers %}
<div class="modal fade" id="histModal-{{ dossier.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header bg-light">
      <h5 class="modal-title">Historique d'attribution — {{ dossier.numero or dossier.id }}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      {% set hist = hist_map.get(dossier.id, []) %}
      {% if hist %}
        <ul class="list-group">
        {% for h in hist %}
          <li class="list-group-item">
            <div class="fw-semibold">
              {{ h.date_attribution.strftime('%d/%m/%Y %H:%M') }}
              — par {{ h.auteur.nom if h.auteur else 'N/A' }}
            </div>
            <div>
              De <em>{{ h.ancien_referent.nom if h.ancien_referent else '—' }}</em>
              à <strong>{{ h.nouveau_referent.nom if h.nouveau_referent else 'N/A' }}</strong>
            </div>
            {% if h.motif %}<div class="text-muted small mt-1">Motif : {{ h.motif }}</div>{% endif %}
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted fst-italic">Aucun historique d’attribution pour ce dossier.</p>
      {% endif %}
    </div>
  </div></div>
</div>
{% endfor %}

{# Modale confirmation suppression #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm"><div class="modal-content">
    <div class="modal-header bg-danger text-white">
      <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
      <button type="button" class="btn btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
    </div>
    <div class="modal-body">
      Êtes-vous sûr de vouloir supprimer ce dossier ? Cette action est irréversible.
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
      <form id="deleteDossierForm" method="POST" style="display:inline;">
        {{ delete_form.hidden_tag() }}
        <button type="submit" class="btn btn-danger">Supprimer</button>
      </form>
    </div>
  </div></div>
</div>
{% endblock %}

{% block scripts %}

<script>
(function () {
  const $table = $('#dossiersTable');

  if (!$.fn.DataTable.isDataTable($table)) {
    $table.DataTable({
      autoWidth: false,
      responsive: true,
      dom: 'frtip',
      language: {
        search: "🔍 Rechercher :",
        zeroRecords: "Aucun dossier trouvé",
        paginate: { previous: "Précédent", next: "Suivant" }
      }
    });
  }
  

  function parentRow($tr) {
    return $tr.hasClass('child') ? $tr.prev('tr') : $tr;
  }

  function openDetailFromRow($tr) {
    const el = $tr.get(0);
    if (!el) return;

    const tds = $tr.find('td');
    const numero    = el.dataset.numero    || (tds.eq(0).text().trim());
    const nom       = el.dataset.nom       || (tds.eq(1).text().trim());
    const client    = el.dataset.client    || (tds.eq(2).text().trim());
    const date      = el.dataset.date      || (tds.eq(3).text().trim());
    const procedure = el.dataset.procedure || (tds.eq(4).text().trim());
    const referent  = el.dataset.referent  || (tds.eq(5).text().trim());
    const statut    = el.dataset.statut    || (tds.eq(6).text().trim());
    const descr     = el.dataset.description || '';

    $('#detail-numero').text(numero);
    $('#detail-nom').text(nom);
    $('#detail-client').text(client);
    $('#detail-date').text(date);
    $('#detail-procedure').text(procedure);
    $('#detail-referent').text(referent);
    $('#detail-description').text(descr);

    const id = el.dataset.id;
    if (id) {
      $('#editDossierLink').attr('href', '/dossiers/modifier/' + id);
      $('#deleteDossierForm').attr('action', '/dossiers/supprimer/' + id);
    }

    const badge = (statut === 'En cours')
      ? '<span class="badge bg-warning text-dark">⏳ En cours</span>'
      : (statut === 'Terminé')
        ? '<span class="badge bg-success">✔️ Terminé</span>'
        : `<span class="badge bg-secondary">${statut}</span>`;
    $('#detail-statut').html(badge);

    const modalEl = document.getElementById('detailDossierModal');
    if (modalEl) new bootstrap.Modal(modalEl).show();
  }

  // Empêche la ligne d’ouvrir la modale détail quand on clique sur le bouton « Historique »
  $table.on('click', 'button[data-bs-target^="#histModal-"]', function (e) {
    e.stopPropagation();
  });

  // Double-clic (avec fallback simple clic)
  let clickTimer = null;
  const CLICK_DELAY = 220;

  $table.on('click', 'tbody tr', function (e) {
    if ($(e.target).closest('button,[data-bs-toggle],a').length) return;
    clearTimeout(clickTimer);
    const $tr = parentRow($(this));
    clickTimer = setTimeout(() => openDetailFromRow($tr), CLICK_DELAY);
  });

  $table.on('dblclick', 'tbody tr', function (e) {
    if ($(e.target).closest('button,[data-bs-toggle],a').length) return;
    clearTimeout(clickTimer);
    const $tr = parentRow($(this));
    openDetailFromRow($tr);
  });

  // Menu contextuel
  $table.on('contextmenu', 'tbody tr', function (e) {
    e.preventDefault();
    $('#context-menu').css({ top: e.pageY + 'px', left: e.pageX + 'px' }).show();
  });
  $(document).on('click', () => $('#context-menu').hide());
  

  // Curseur
  $('<style>#dossiersTable tbody tr{cursor:pointer}</style>').appendTo(document.head);
})();

(function () {
  // ===== Compact mode pour #dossiersTable (corps + en-têtes) =====
  (function compactDossiersTable() {
    const css = `
      /* Corps : police + paddings réduits */
      #dossiersTable.compact tbody td{
        font-size:12px !important;
        padding:4px 6px !important;
        line-height:1.1 !important;
        white-space:nowrap;                /* garde fin, comme pour timesheets */
      }

      /* Badges plus petits (Statut, etc.) */
      #dossiersTable.compact .badge{
        font-size:10px !important;
        padding:.15rem .35rem !important;
      }

      /* En-têtes uniquement (comme demandé) */
      #dossiersTable.compact thead th{
        font-size:10px !important;
        padding:3px 6px !important;
        line-height:1.05 !important;
        vertical-align:middle !important;
        white-space:nowrap !important;
      }
      /* Icônes de tri (Bootstrap/DataTables) plus fines + rapprochées */
      #dossiersTable.dataTable thead th.sorting,
      #dossiersTable.dataTable thead th.sorting_asc,
      #dossiersTable.dataTable thead th.sorting_desc{
        padding-right:14px !important;
        background-size:9px 9px !important;
        background-position:right 4px center !important;
      }
      #dossiersTable thead .sorting:before,
      #dossiersTable thead .sorting_asc:before,
      #dossiersTable thead .sorting_desc:before,
      #dossiersTable thead .sorting:after,
      #dossiersTable thead .sorting_asc:after,
      #dossiersTable thead .sorting_desc:after{
        font-size:.6rem !important;
        right:.25rem !important;
      }

      /* Optionnel : autoriser l'enroulement d'une colonne si tu mets class="wrap" */
      #dossiersTable.compact .wrap{
        white-space:normal !important;
        max-width:260px;
      }
    `;
    if (!document.getElementById('dossiers-compact-css')) {
      const style = document.createElement('style');
      style.id = 'dossiers-compact-css';
      style.textContent = css;
      document.head.appendChild(style);
    }

    // Active le mode compact + recalage colonnes si la DataTable est prête
    const tbl = document.getElementById('dossiersTable');
    if (tbl) tbl.classList.add('compact');
    try { setTimeout(() => $('#dossiersTable').DataTable().columns.adjust().draw(false), 0); } catch(e) {}
  })();
})();


</script>
{% endblock %}
