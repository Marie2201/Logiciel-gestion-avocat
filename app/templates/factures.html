{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="container py-4 px-4 rounded shadow-sm" style="background-color: #fff9e6;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary"><i class="bi bi-receipt"></i> Gestion des Factures</h2>
            <div class="btn-group">
                <a href="{{ url_for('generer_facture') }}" class="btn btn-warning shadow">
                    <i class="bi bi-calculator"></i> Générer une facture
                </a>
            </div>
        </div>

        <table id="facturesTable" 
        class="table table-striped table-bordered table-hover table-responsive shadow-sm rounded w-100 overflow-hidden" 
        style="background-color: #fdf5e6;border: 1px solid #f0d98c;">
         <thead style="background-color: #f0d98c; color: #000;">
                <tr>
                    <th>Date</th>
                    <th>Montant HT</th>
                    <th>Montant TTC</th>
                    <th>Statut</th>
                    <th>Client</th>
                    <th>Dossier</th>
                </tr>
            </thead>
            <tbody>
                {% for facture in factures %}
                <tr class="facture-row"
                    data-id="{{ facture.id }}"
                    data-date="{{ facture.date.strftime('%d/%m/%Y') }}"
                    data-montant-ht="{{ '{:,.2f} FCFA'.format(facture.montant_ht) }}"
                    data-montant-ttc="{{ '{:,.2f} FCFA'.format(facture.montant_ttc) }}"
                    data-statut="{{ facture.statut }}"
                    data-dossier="{{ facture.dossier_nom }}"
                    data-client="{{ facture.client_nom }}">
                    
                    <td>{{ facture.date.strftime('%d/%m/%Y') }}</td>
                    <td>{{ '{:,.2f} XOF'.format(facture.montant_ht) }}</td>
                    <td>{{ '{:,.2f} XOF'.format(facture.montant_ttc) }}</td>
                    <td>
                        {% if facture.statut == 'En attente' %}
                            <span class="badge bg-warning text-dark">⏳ En attente</span>
                        {% elif facture.statut == 'Payée' %}
                            <span class="badge bg-success">✔️ Payée</span>
                        {% elif facture.statut == 'Annulée' %}
                            <span class="badge bg-danger">❌ Annulée</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ facture.statut }}</span>
                        {% endif %}
                    </td>
                    <td>{{ facture.client_nom }}</td>
                    <td>{{ facture.dossier_nom }}</td>
                    
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<div class="modal fade" id="ajouterFactureModal" tabindex="-1" aria-labelledby="ajouterFactureModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" class="modal-content">
      {{ add_form.hidden_tag() }} {# Crucial pour la protection CSRF de ce formulaire #}
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="ajouterFactureModalLabel">Ajouter une facture</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-md-6">
          {{ add_form.date.label(class="form-label") }}
          {{ add_form.date(class="form-control") }}
          {% if add_form.date.errors %}<div class="text-danger">{% for error in add_form.date.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
        <div class="col-md-6">
          {{ add_form.dossier.label(class="form-label") }}
          {{ add_form.dossier(class="form-select") }} {# QuerySelectField s'affiche comme un select #}
          {% if add_form.dossier.errors %}<div class="text-danger">{% for error in add_form.dossier.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
        <div class="col-md-4">
          {{ add_form.montant_ht.label(class="form-label") }}
          {{ add_form.montant_ht(class="form-control") }}
          {% if add_form.montant_ht.errors %}<div class="text-danger">{% for error in add_form.montant_ht.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
        <div class="col-md-4">
          {{ add_form.montant_ttc.label(class="form-label") }}
          {{ add_form.montant_ttc(class="form-control") }}
          {% if add_form.montant_ttc.errors %}<div class="text-danger">{% for error in add_form.montant_ttc.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
        <div class="col-md-4">
          {{ add_form.statut.label(class="form-label") }}
          {{ add_form.statut(class="form-select") }}
          {% if add_form.statut.errors %}<div class="text-danger">{% for error in add_form.statut.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
      </div>
      <div class="modal-footer">
        {{ add_form.submit(class="btn btn-success") }} {# Ce sera ton bouton 'Enregistrer' #}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i> Annuler</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="factureDetailsModal" tabindex="-1" aria-labelledby="factureDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="factureDetailsModalLabel"><i class="bi bi-file-earmark-text me-2"></i>Détails de la Facture</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card h-100 shadow-sm border-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary"><i class="bi bi-calendar-check me-2"></i>Informations générales</h6>
                        <hr>
                        <p class="card-text mb-1"><strong>Date :</strong> <span id="detail-facture-date" class="fw-normal"></span></p>
                        <p class="card-text mb-0"><strong>Dossier :</strong> <span id="detail-facture-dossier-titre" class="fw-normal"></span></p>
                        <p><strong>Client :</strong> <span id="detail-facture-client"></span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100 shadow-sm border-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary"><i class="bi bi-currency-euro me-2"></i>Montants</h6>
                        <hr>
                        <p class="card-text mb-1"><strong>Montant HT :</strong> <span id="detail-facture-montant-ht" class="fw-normal text-success fw-bold"></span></p>
                        <p class="card-text mb-0"><strong>Montant TTC :</strong> <span id="detail-facture-montant-ttc" class="fw-normal text-success fw-bold"></span></p>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card shadow-sm border-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary"><i class="bi bi-info-circle me-2"></i>Statut de la Facture</h6>
                        <hr>
                        <p class="card-text mb-0"><strong>Statut :</strong> <span id="detail-facture-statut" class="fw-normal"></span></p>
                        <p class="text-muted small mb-0 mt-3">
                            <i class="bi bi-exclamation-circle me-1"></i>Le statut indique l'état actuel de la facture.
                        </p>
                    </div>
                </div>
            </div>
            {# Si tu as une description pour la facture, tu peux l'ajouter ici #}
            {#
            <div class="col-12 mt-3">
                <div class="card shadow-sm border-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary"><i class="bi bi-text-left me-2"></i>Description</h6>
                        <hr>
                        <p id="detail-facture-description" class="card-text text-muted fst-italic"></p>
                    </div>
                </div>
            </div>
            #}
        </div>
      </div>
      <div class="modal-footer">
                <a id="editFactureLink" class="btn btn-outline-primary">Modifier</a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

{# Modal de confirmation de suppression (remplace confirm()) #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer ce facture ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteFactureForm" method="POST" style="display:inline;">
                    {{ delete_form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="contextMenu" class="dropdown-menu shadow rounded" style="display:none; position:absolute; z-index:1000;">
    <ul class="list-unstyled m-0">
        <li><a class="dropdown-item" href="#" id="exportExcel"><i class="bi bi-file-earmark-excel"></i> Exporter en Excel</a></li>
        <li><a class="dropdown-item" href="#" id="exportPDF"><i class="bi bi-file-pdf"></i> Exporter en PDF</a></li>
        <li><a class="dropdown-item" href="#" id="printTable"><i class="bi bi-printer"></i> Imprimer</a></li>
    </ul>
</div>

{% endblock %}

{% block scripts %}
<script>
function showFactureDetail(row) {
    document.getElementById('detail-client').innerText = row.dataset.client;
    document.getElementById('detail-dossier').innerText = row.dataset.dossier;
    document.getElementById('detail-date').innerText = row.dataset.date;
    document.getElementById('detail-montant-ht').innerText = row.dataset.montant_ht + ' FCFA';
    document.getElementById('detail-montant-ttc').innerText = row.dataset.montant_ttc + ' FCFA';
    document.getElementById('detail-statut').innerText = row.dataset.statut;

    const modal = new bootstrap.Modal(document.getElementById('factureDetailModal'));
    modal.show();
}

$(document).ready(function () {
    const table = $('#facturesTable').DataTable({ // Changé de dossiersTable à facturesTable
        autoWidth: false,
        responsive: true,
        dom: 'frtip', // 'B' active les boutons d'exportation
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="bi bi-file-earmark-excel"></i> Exporter Excel',
                filename: 'factures_excel', // Nom de fichier spécifique aux factures
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5] // Ajusté aux colonnes des factures
                }
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="bi bi-file-pdf"></i> Exporter PDF',
                filename: 'factures_pdf', // Nom de fichier spécifique aux factures
                orientation: 'portrait', // Souvent plus adapté pour les factures simples
                pageSize: 'A4',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5]
                }
            },
            {
                extend: 'print',
                text: '<i class="bi bi-printer"></i> Imprimer',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4, 5]
                }
            }
        ],
        language: {
            search: "🔍 Rechercher :",
            lengthMenu: "",
            info: "",
            infoEmpty: "",
            paginate: {
                previous: "Précédent",
                next: "Suivant"
            },
            zeroRecords: "Aucune facture trouvée" // Message spécifique
        }
    });

    // Double clic = ouvrir modal de détail
    $('.facture-row').on('dblclick', function() {
    const factureId = $(this).data('id');
    
    // Renseigner les détails
    $('#detail-facture-date').text($(this).data('date'));
    $('#detail-facture-montant-ht').text($(this).data('montant-ht'));
    $('#detail-facture-montant-ttc').text($(this).data('montant-ttc'));
    
    $('#detail-facture-dossier-titre').text($(this).data('dossier'));
    $('#detail-facture-client').text($(this).data('client'));

    const statutFactureText = $(this).data('statut');
    let statutFactureBadgeHtml = `<span class="badge bg-secondary">${statutFactureText}</span>`;
    if (statutFactureText === 'En attente') {
        statutFactureBadgeHtml = `<span class="badge bg-warning text-dark">${statutFactureText}</span>`;
    } else if (statutFactureText === 'Payée') {
        statutFactureBadgeHtml = `<span class="badge bg-success">${statutFactureText}</span>`;
    } else if (statutFactureText === 'Annulée') {
        statutFactureBadgeHtml = `<span class="badge bg-danger">${statutFactureText}</span>`;
    }
    $('#detail-facture-statut').html(statutFactureBadgeHtml);

    // Met à jour les liens Modifier et Supprimer dynamiquement
    $('#editFactureLink').attr('href', '/factures/modifier/' + factureId);
    $('#deleteFactureForm').attr('action', '/supprimer_facture/' + factureId);
    
    $('#factureDetailsModal').modal('show');
   });


    // Menu clic droit
    $('#facturesTable tbody').on('contextmenu', 'tr', function(e) {
        e.preventDefault();
        $('#contextMenu').css({
            top: e.pageY + 'px',
            left: e.pageX + 'px'
        }).show();
    });

    $(document).click(function() {
        $('#contextMenu').hide();
    });

    // Déclenchement des actions d'export/impression via les boutons DataTables
    $('#exportExcel').on('click', function (e) {
        e.preventDefault();
        table.button('.buttons-excel').trigger();
    });

    $('#exportPDF').on('click', function (e) {
        e.preventDefault();
        table.button('.buttons-pdf').trigger();
    });

    $('#printTable').on('click', function (e) {
        e.preventDefault();
        table.button('.buttons-print').trigger();
    });

    // Auto-disparition des messages flash
    setTimeout(() => {
        const alerts = document.querySelectorAll('#flash-messages .alert');
        alerts.forEach(el => {
            el.classList.remove('show');
            el.classList.add('fade');
            setTimeout(() => el.remove(), 500);
        });
    }, 5000);
});
</script>
{% endblock %}