{% extends "base.html" %}

{% block title %}Gestion des Timesheets{% endblock %}

{% block content %}
<div class="container mt-4"> 
  <div class="container py-4 px-4 rounded shadow-lg" style="background-color: #eafae5;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary">üïí Gestion des Timesheets</h2>
      <button class="btn btn-success shadow" data-bs-toggle="modal" data-bs-target="#ajoutTimesheetModal">
        <i class="bi bi-plus-circle"></i> Ajouter un timesheet
      </button>
    </div>

    <style>
      #timesheetsTable { width: 100% !important; }
    </style>

    <table id="timesheetsTable" 
      class="table table-striped table-bordered table-hover shadow-sm rounded w-100 overflow-hidden" 
      style="background-color: #eafae5; border: 1px solid #c5e7bc;">
      <thead style="background-color: #c5e7bc; color: #000;">
        <tr>
          <th>Date</th>
          <th>D√©but</th>
          <th>Fin</th>
          <th>Dur√©e (h)</th>
          <th>Client</th>
          <th>Dossier</th>
          <th>Utilisateur</th>
          <th>Type</th>
          <th>Devise</th>
          <th>Taux horaire</th>
          <th>Montant HT</th>
          <th>Montant TTC</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% for ts in timesheets %}
        {% set unit = 'FCFA' if ts.devise=='XOF' else ('‚Ç¨' if ts.devise=='EUR' else ('$' if ts.devise=='USD' else ts.devise)) %}
        <tr class="ts-row" ondblclick="showTimesheetDetail(this)"
            data-id="{{ ts.id }}"
            data-client="{{ ts.dossier.client.societe }}"
            data-dossier="{{ ts.dossier.numero }} ‚Äì {{ ts.dossier.nom }}"
            data-user="{{ ts.user.nom if ts.user else '‚Äî' }}"
            data-date="{{ ts.date.strftime('%d/%m/%Y') }}"
            data-heure_debut="{{ ts.heure_debut.strftime('%H:%M') if ts.heure_debut else '' }}"
            data-heure_fin="{{ ts.heure_fin.strftime('%H:%M') if ts.heure_fin else '' }}"
            data-description="{{ ts.description or '' }}"
            data-statut="{{ ts.statut }}"
            data-type="{{ ts.type_facturation or 'horaire' }}"
            data-devise="{{ ts.devise or 'XOF' }}"
            data-taux_horaire="{{ '%.2f'|format(ts.taux_horaire or 0) if ts.type_facturation=='horaire' else '' }}"
            data-montant_forfait="{{ '%.2f'|format(ts.montant_forfait or 0) if ts.type_facturation=='forfait' else '' }}"
            data-montant_ht="{{ '%.2f'|format(ts.montant_ht or 0) }}"
            data-montant_ttc="{{ '%.2f'|format(ts.montant_ttc or 0) }}"
            data-duree_heures="{{ '%.2f'|format(ts.duree_heures) if ts.duree_heures is not none else '' }}">
          <td>{{ ts.date.strftime('%d/%m/%Y') }}</td>
          <td>{{ ts.heure_debut.strftime('%H:%M') if ts.heure_debut else '‚Äî' }}</td>
          <td>{{ ts.heure_fin.strftime('%H:%M') if ts.heure_fin else '‚Äî' }}</td>
          <td>{{ '%.2f'|format(ts.duree_heures) if ts.duree_heures is not none else '‚Äî' }}</td>
          <td>{{ ts.dossier.client.societe }}</td>
          <td>{{ ts.dossier.numero }} ‚Äì {{ ts.dossier.nom }}</td>
          <td>{{ ts.user.nom if ts.user else '‚Äî' }}</td>
          <td>
            {% if ts.type_facturation == 'forfait' %}
              <span class="badge bg-info">Forfait</span>
            {% else %}
              <span class="badge bg-secondary">Horaire</span>
            {% endif %}
          </td>
          <td>{{ unit }}</td>
          <td>
            {% if ts.type_facturation == 'horaire' %}
              {{ '%.2f'|format(ts.taux_horaire or 0) }} {{ unit }}
            {% else %} ‚Äî {% endif %}
          </td>
          <td>{{ '%.2f'|format(ts.montant_ht or 0) }} {{ unit }}</td>
          <td>{{ '%.2f'|format(ts.montant_ttc or 0) }} {{ unit }}</td>
          <td>
            <span class="badge 
              {% if ts.statut and ts.statut|lower|trim == 'factur√©' %}bg-success
              {% elif ts.statut and ts.statut|lower|trim == 'en cours' %}bg-warning
              {% elif ts.statut and ts.statut|lower|trim == 'brouillon' %}bg-info
              {% else %}bg-secondary{% endif %}">
              {{ ts.statut }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


{# Modal : Ajouter un Timesheet #}
<div class="modal fade" id="ajoutTimesheetModal" tabindex="-1" aria-labelledby="ajoutTimesheetLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="ajoutTimesheetLabel">Ajouter un Timesheet</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            {{ form.type_facturation.label(class="form-label") }}
            {{ form.type_facturation(class="form-select", id="type_facturation") }}
          </div>

          <div class="col-md-6">
            {{ form.devise.label(class="form-label") }}
            {{ form.devise(class="form-select", id="devise") }}
          </div>

          <div class="col-md-6 row-forfait">
            {{ form.montant_forfait.label(class="form-label") }}
            {{ form.montant_forfait(class="form-control", id="montant_forfait") }}
          </div>

          <div class="col-md-4 row-horaire">
            {{ form.heure_debut.label(class="form-label") }}
            {{ form.heure_debut(class="form-control", id="heure_debut") }}
          </div>
          <div class="col-md-4 row-horaire">
            {{ form.heure_fin.label(class="form-label") }}
            {{ form.heure_fin(class="form-control", id="heure_fin") }}
          </div>
          <div class="col-md-4 row-horaire">
            {{ form.taux_horaire.label(class="form-label") }}
            {{ form.taux_horaire(class="form-control", id="taux_horaire") }}
          </div>

          <div class="col-md-4">
            {{ form.date.label(class="form-label") }}
            {{ form.date(class="form-control") }}
          </div>

          <div class="col-md-12">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows=2) }}
          </div>

          <div class="col-md-6">
            {{ form.dossier_id.label(class="form-label") }}
            {{ form.dossier_id(class="form-select") }}
          </div>

          <div class="col-md-6">
            {{ form.tva_applicable.label(class="form-label") }}
            {{ form.tva_applicable(class="form-select", id="tva_applicable") }}
          </div>

          <div class="col-md-6">
            {{ form.statut.label(class="form-label") }}
            {{ form.statut(class="form-select") }}
          </div>

          <div class="col-md-4">
            <label>Dur√©e estim√©e :</label>
            <p id="duree_affichee" class="form-control-plaintext">-</p>
          </div>
          <div class="col-md-4">
            <label>Montant HT :</label>
            <p id="montant_ht" class="form-control-plaintext">-</p>
          </div>
          <div class="col-md-4">
            <label>Montant TTC :</label>
            <p id="montant_ttc" class="form-control-plaintext">-</p>
          </div>
        </div>
        <div class="modal-footer">
          {{ form.submit(class="btn btn-success") }}
        </div>
      </form>
    </div>
  </div>
</div>

{# Modal d√©tail (inchang√© sauf unit√© dynamique c√¥t√© JS) #}
<div class="modal fade" id="detailTimesheetModal" tabindex="-1" aria-labelledby="detailTimesheetLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="detailTimesheetLabel">D√©tail du Timesheet</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="card h-100 shadow-sm border-light">
              <div class="card-body">
                <h6 class="card-title text-primary"><i class="bi bi-calendar-check me-2"></i>Informations g√©n√©rales</h6>
                <hr>
                <p class="card-text mb-1"><strong>Client :</strong> <span id="detail-client"></span></p>
                <p class="card-text mb-1"><strong>Dossier :</strong> <span id="detail-dossier"></span></p>
                <p class="card-text mb-1"><strong>Date :</strong> <span id="detail-date"></span></p>
                <p class="card-text mb-1"><strong>D√©but :</strong> <span id="detail-debut"></span></p>
                <p class="card-text mb-1"><strong>Fin :</strong> <span id="detail-fin"></span></p>
                <p class="card-text mb-0"><strong>Dur√©e :</strong> <span id="detail-duree" class="text-success fw-bold"></span></p>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card h-100 shadow-sm border-light">
              <div class="card-body">
                <h6 class="card-title text-primary"><i class="bi bi-currency-exchange me-2"></i>D√©tails financiers</h6>
                <hr>
                <p class="card-text mb-1"><strong>Taux horaire :</strong> <span id="detail-taux" class="text-info"></span></p>
                <p class="card-text mb-1"><strong>Montant HT :</strong> <span id="detail-ht" class="text-success fw-bold"></span></p>
                <p class="card-text mb-1"><strong>Montant TTC :</strong> <span id="detail-ttc" class="text-success fw-bold"></span></p>
                <p class="card-text mb-0"><strong>Statut :</strong> <span id="detail-statut" class="badge bg-secondary"></span></p>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm border-light">
              <div class="card-body">
                <h6 class="card-title text-primary"><i class="bi bi-text-left me-2"></i>Description</h6>
                <hr>
                <p id="detail-description" class="text-muted fst-italic"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a id="editTimesheetLink" class="btn btn-outline-primary">Modifier</a>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{# Modal confirmation suppression #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
        <button type="button" class="btn btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        √ätes-vous s√ªr de vouloir supprimer ce timesheet ? Cette action est irr√©versible.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form id="deleteTimesheetForm" method="POST" style="display:inline;">
          {{ delete_form.hidden_tag() }}
          <button type="submit" class="btn btn-danger">Supprimer</button>
        </form>
      </div>
    </div>
  </div>
</div>

{# Menu contextuel #}
<div id="context-menu" class="shadow rounded" style="display: none; position: absolute; z-index: 9999; background-color: white; border: 1px solid #ccc; padding: 5px;">
  <ul class="list-unstyled m-0">
    <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
    <li><a href="#" id="exportPDF" class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
    <li><a href="#" id="printTable" class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
  </ul>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

<script>
(function () {
  "use strict";

  // --- utilitaires ---
  function currencyLabelFrom(code) {
    if (code === 'EUR') return '‚Ç¨';
    if (code === 'USD') return '$';
    return 'FCFA'; // XOF
  }

  function showTimesheetDetail(row) {
    const id   = row.dataset.id;
    const typ  = row.dataset.type || 'horaire';
    const unit = currencyLabelFrom(row.dataset.devise || 'XOF');

    const setText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

    setText('detail-client',       row.dataset.client || '‚Äî');
    setText('detail-dossier',      row.dataset.dossier || '‚Äî');
    setText('detail-date',         row.dataset.date || '‚Äî');
    setText('detail-statut',       row.dataset.statut || '‚Äî');
    setText('detail-description',  row.dataset.description || '');

    if (typ === 'forfait') {
      setText('detail-debut', '‚Äî');
      setText('detail-fin',   '‚Äî');
      setText('detail-duree', '‚Äî');
      setText('detail-taux',  '‚Äî');
    } else {
      setText('detail-debut', row.dataset.heure_debut || '‚Äî');
      setText('detail-fin',   row.dataset.heure_fin   || '‚Äî');
      setText('detail-duree', row.dataset.duree_heures ? row.dataset.duree_heures + ' h' : '‚Äî');
      setText('detail-taux',  row.dataset.taux_horaire ? row.dataset.taux_horaire + ' ' + unit : '‚Äî');
    }

    setText('detail-ht',  row.dataset.montant_ht  ? row.dataset.montant_ht  + ' ' + unit : '‚Äî');
    setText('detail-ttc', row.dataset.montant_ttc ? row.dataset.montant_ttc + ' ' + unit : '‚Äî');

    const editLink = document.getElementById('editTimesheetLink');
    const delForm  = document.getElementById('deleteTimesheetForm');
    if (editLink) editLink.href = "/edit_timesheet/" + id;
    if (delForm)  delForm.action = '/timesheet/delete/' + id;

    const modalEl = document.getElementById('detailTimesheetModal');
    if (modalEl && window.bootstrap?.Modal) new bootstrap.Modal(modalEl).show();
  }
  // Rendre accessible pour un onclick HTML
  window.showTimesheetDetail = showTimesheetDetail;

  document.addEventListener('DOMContentLoaded', function () {
    // --- DataTable (DEFINI ICI) ---
    const table = $('#timesheetsTable').DataTable({
      autoWidth: false,
      responsive: true,
      // Boutons + Select ‚Üí n√©cessite les extensions charg√©es
      dom: 'frtip',
      buttons: ['excel', 'pdf', 'print'],
      select: { style: 'multi' },
      language: {
        search: "üîç Rechercher :", lengthMenu: "Afficher _MENU_ entr√©es",
        info: "Affichage de _START_ √† _END_ sur _TOTAL_ entr√©es",
        infoEmpty: "Affichage de 0 √† 0 sur 0 entr√©e",
        infoFiltered: "(filtr√© de _MAX_ entr√©es totales)",
        paginate: { previous: "Pr√©c√©dent", next: "Suivant" },
        zeroRecords: "Aucun timesheet trouv√©"
      }
    });

    // ------- S√©lection & cases √† cocher -------
    const $container = $(table.table().container());

    function syncCheckboxes() {
      table.rows({ page: 'current' }).every(function () {
        const node = this.node();
        const cb = $(node).find('input.row-check').get(0);
        if (cb) cb.checked = this.selected();
      });
    }

    function updateCheckAllState() {
      const total = table.rows({ search: 'applied' }).count();
      const selected = table.rows({ search: 'applied', selected: true }).count();
      const allChecked = (total > 0 && selected === total);
      const indet = (selected > 0 && selected < total);
      $container.find('thead input#check-all').each(function () {
        this.checked = allChecked;
        this.indeterminate = indet;
      });
    }

    $container.on('change', 'thead input#check-all', function () {
      if (this.checked) table.rows({ search: 'applied' }).select();
      else table.rows({ search: 'applied' }).deselect();
      syncCheckboxes(); updateCheckAllState();
    });

    $('#timesheetsTable tbody').on('click', 'input.row-check', function (e) {
      e.stopPropagation();
      const row = table.row($(this).closest('tr'));
      if (this.checked) row.select(); else row.deselect();
      updateCheckAllState();
    });

    table.on('select deselect', function (e, dt, type, indexes) {
      if (type === 'row') {
        indexes.forEach(idx => {
          const node = dt.row(idx).node();
          const cb = $(node).find('input.row-check').get(0);
          if (cb) cb.checked = dt.row(idx).selected();
        });
        updateCheckAllState();
      }
    });

    table.on('draw', function () { syncCheckboxes(); updateCheckAllState(); });

    // ------- Menu clic droit -------
    $('#timesheetsTable tbody').on('contextmenu', 'tr', function (e) {
      e.preventDefault();
      const row = table.row(this);
      if (!row.selected()) {
        row.select();
        $(this).find('input.row-check').prop('checked', true);
        updateCheckAllState();
      }
      $('#context-menu').css({ top: e.pageY + 'px', left: e.pageX + 'px' }).show();
    });
    $(document).on('click', function () { $('#context-menu').hide(); });

    function needSelectionOrWarn(action) {
      const count = table.rows({ selected: true }).count();
      if (count === 0) { alert('S√©lectionnez au moins un timesheet (cochez les cases) avant d‚Äôexporter.'); return; }
      action();
    }
    $('#exportExcel').on('click', e => { e.preventDefault(); needSelectionOrWarn(() => table.button('.buttons-excel').trigger()); });
    $('#exportPDF')  .on('click', e => { e.preventDefault(); needSelectionOrWarn(() => table.button('.buttons-pdf').trigger()); });
    $('#printTable') .on('click', e => { e.preventDefault(); needSelectionOrWarn(() => table.button('.buttons-print').trigger()); });

    // ------- Formulaire d‚Äôajout : affichage + calculs -------
    const typeSelect     = document.getElementById('type_facturation');
    const rowHoraire     = document.querySelectorAll('.row-horaire');
    const rowForfait     = document.querySelectorAll('.row-forfait');
    const heureDebut     = document.getElementById('heure_debut');
    const heureFin       = document.getElementById('heure_fin');
    const tauxHoraire    = document.getElementById('taux_horaire');
    const montantForfait = document.getElementById('montant_forfait');

    const selectedUnit = () => {
      const sel = document.getElementById('devise');
      return currencyLabelFrom(sel?.value || 'XOF');
    };

    function toggleFields() {
      const isForfait = typeSelect && typeSelect.value === 'forfait';
      rowHoraire.forEach(el => el.style.display = isForfait ? 'none' : '');
      rowForfait.forEach(el => el.style.display = isForfait ? '' : 'none');
      if (heureDebut)      heureDebut.required      = !isForfait;
      if (heureFin)        heureFin.required        = !isForfait;
      if (tauxHoraire)     tauxHoraire.required     = !isForfait;
      if (montantForfait)  montantForfait.required  =  isForfait;
      calculerDureeEtMontants();
    }

    function calculerDureeEtMontants() {
      const tvaSelect = document.getElementById('tva_applicable');
      const tvaVal = tvaSelect?.options[tvaSelect.selectedIndex]?.value;
      const tvaRate = 0.18;
      const unit = selectedUnit();

      const set = (id, txt) => { const el = document.getElementById(id); if (el) el.innerText = txt; };

      if (typeSelect && typeSelect.value === 'forfait') {
        const forfait = parseFloat((montantForfait?.value || '0').replace(',', '.')) || 0;
        if (forfait > 0) {
          const ht = forfait;
          const ttc = (tvaVal === 'oui') ? Math.round(ht * (1 + tvaRate) * 100) / 100 : ht;
          set('duree_affichee', "‚Äî");
          set('montant_ht',  ht.toFixed(2)  + " " + unit);
          set('montant_ttc', ttc.toFixed(2) + " " + unit);
          return;
        }
        set('duree_affichee', "-"); set('montant_ht', "-"); set('montant_ttc', "-");
        return;
      }

      const debut = heureDebut?.value;
      const fin   = heureFin?.value;
      const taux  = parseFloat(tauxHoraire?.value?.replace(',', '.') || '0') || 0;

      if (debut && fin && taux >= 0) {
        const [h1, m1] = debut.split(':').map(Number);
        const [h2, m2] = fin.split(':').map(Number);
        let dureeMin = (h2 * 60 + m2) - (h1 * 60 + m1);
        if (dureeMin < 0) dureeMin += 24 * 60;
        const dureeH = Math.round((dureeMin / 60) * 100) / 100;

        const ht  = Math.round(dureeH * taux * 100) / 100;
        const ttc = (tvaVal === 'oui') ? Math.round(ht * (1 + tvaRate) * 100) / 100 : ht;

        set('duree_affichee', dureeH.toFixed(2) + " h");
        set('montant_ht',  ht.toFixed(2)  + " " + unit);
        set('montant_ttc', ttc.toFixed(2) + " " + unit);
      } else {
        set('duree_affichee', "-"); set('montant_ht', "-"); set('montant_ttc', "-");
      }
    }

    if (typeSelect) typeSelect.addEventListener('change', toggleFields);
    ['heure_debut','heure_fin','taux_horaire','montant_forfait','tva_applicable','devise'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const evt = (id === 'tva_applicable' || id === 'devise') ? 'change' : 'input';
      el.addEventListener(evt, calculerDureeEtMontants);
    });

    // Init
    toggleFields();
    calculerDureeEtMontants();

    // Disparition auto des flashs
    setTimeout(() => {
      const alerts = document.querySelectorAll('#flash-messages .alert');
      alerts.forEach(el => {
        el.classList.remove('show'); el.classList.add('fade');
        setTimeout(() => el.remove(), 500);
      });
    }, 5000);
  });
})();
</script>

{% endblock %}

