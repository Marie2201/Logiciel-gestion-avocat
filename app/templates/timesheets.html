{% extends "base.html" %}

{% block title %}Gestion des Timesheets{% endblock %}

{% block content %}
<div class="container mt-4"> 
  <div class="container py-4 px-4 rounded shadow-lg" style="background-color: #eafae5;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <!--<h2 class="text-primary">üïí Gestion des Timesheets</h2>-->
      <button class="btn btn-success shadow" data-bs-toggle="modal" data-bs-target="#ajoutTimesheetModal">
        <i class="bi bi-plus-circle"></i> Ajouter un timesheet
      </button>
    </div>

    <style>
      #timesheetsTable { width: 100% !important; }
    </style>

    <table id="timesheetsTable" 
      class="table table-striped table-bordered table-hover shadow-sm rounded w-100 overflow-hidden" 
      style="background-color: #eafae5; border: 1px solid #c5e7bc;">
      <thead style="background-color: #c5e7bc; color: #000;">
        <tr>
          <th>Client</th>
          <th>Date</th>
          <th>D√©but</th>
          <th>Fin</th>
          <th>Dur√©e (h)</th>
          <th>Dossier</th>
          <th>Utilisateur</th>
          <th>Type</th>
          <th>Devise</th>
          <th>Taux horaire</th>
          <th>Montant HT</th>
          <th>Montant TTC</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody>
        {% for ts in timesheets %}
        {% set unit = 'FCFA' if ts.devise=='XOF' else ('‚Ç¨' if ts.devise=='EUR' else ('$' if ts.devise=='USD' else ts.devise)) %}
        <tr class="ts-row" ondblclick="showTimesheetDetail(this)"
            data-client_id="{{ ts.dossier.client.id }}"
            data-id="{{ ts.id }}"
            data-client="{{ ts.dossier.client.societe }}"
            data-dossier="{{ ts.dossier.numero }} ‚Äì {{ ts.dossier.nom }}"
            data-user="{{ ts.user.nom if ts.user else '‚Äî' }}"
            data-date="{{ ts.date.strftime('%d/%m/%Y') }}"
            data-heure_debut="{{ ts.heure_debut.strftime('%H:%M') if ts.heure_debut else '' }}"
            data-heure_fin="{{ ts.heure_fin.strftime('%H:%M') if ts.heure_fin else '' }}"
            data-description="{{ ts.description or '' }}"
            data-statut="{{ ts.statut }}"
            data-type="{{ ts.type_facturation or 'horaire' }}"
            data-devise="{{ ts.devise or 'XOF' }}"
            data-taux_horaire="{{ '%.2f'|format(ts.taux_horaire or 0) if ts.type_facturation=='horaire' else '' }}"
            data-montant_forfait="{{ '%.2f'|format(ts.montant_forfait or 0) if ts.type_facturation=='forfait' else '' }}"
            data-montant_ht="{{ '%.2f'|format(ts.montant_ht or 0) }}"
            data-montant_ttc="{{ '%.2f'|format(ts.montant_ttc or 0) }}"
            data-duree_heures="{{ '%.2f'|format(ts.duree_heures) if ts.duree_heures is not none else '' }}">
          <!-- ORDRE align√© au THEAD -->
          <td>{{ ts.dossier.client.societe }}</td>                                 <!-- Client -->
          <td>{{ ts.date.strftime('%d/%m/%Y') }}</td>                               <!-- Date -->
          <td>{{ ts.heure_debut.strftime('%H:%M') if ts.heure_debut else '‚Äî' }}</td><!-- D√©but -->
          <td>{{ ts.heure_fin.strftime('%H:%M') if ts.heure_fin else '‚Äî' }}</td>    <!-- Fin -->
          <td>{{ '%.2f'|format(ts.duree_heures) if ts.duree_heures is not none else '‚Äî' }}</td> <!-- Dur√©e (h) -->
          <td>{{ ts.dossier.numero }} ‚Äì {{ ts.dossier.nom }}</td>                   <!-- Dossier -->
          <td>{{ ts.user.nom if ts.user else '‚Äî' }}</td>                            <!-- Utilisateur -->
          <td>
            {% if ts.type_facturation == 'forfait' %}
              <span class="badge bg-info">Forfait</span>
            {% else %}
              <span class="badge bg-secondary">Horaire</span>
            {% endif %}
          </td>                                                                      <!-- Type -->
          {% set unit = 'FCFA' if ts.devise=='XOF' else ('‚Ç¨' if ts.devise=='EUR' else ('$' if ts.devise=='USD' else ts.devise)) %}
          <td>{{ unit }}</td>                                                        <!-- Devise -->
          <td>{% if ts.type_facturation == 'horaire' %}{{ '%.2f'|format(ts.taux_horaire or 0) }} {{ unit }}{% else %}‚Äî{% endif %}</td> <!-- Taux -->
          <td>{{ '%.2f'|format(ts.montant_ht or 0) }} {{ unit }}</td>               <!-- HT -->
          <td>{{ '%.2f'|format(ts.montant_ttc or 0) }} {{ unit }}</td>              <!-- TTC -->
          <td>
            <span class="badge 
              {% if ts.statut and ts.statut|lower|trim == 'factur√©' %}bg-success
              {% elif ts.statut and ts.statut|lower|trim == 'en cours' %}bg-warning
              {% elif ts.statut and ts.statut|lower|trim == 'brouillon' %}bg-info
              {% else %}bg-secondary{% endif %}">
              {{ ts.statut }}
            </span>
          </td>                                                                      <!-- Statut -->
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


{# Modal : Ajouter un Timesheet #}
<div class="modal fade" id="ajoutTimesheetModal" tabindex="-1" aria-labelledby="ajoutTimesheetLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="ajoutTimesheetLabel">Ajouter un Timesheet</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body row g-3">
          <div class="col-md-6">
            {{ form.type_facturation.label(class="form-label") }}
            {{ form.type_facturation(class="form-select", id="type_facturation") }}
          </div>

          <div class="col-md-6">
            {{ form.devise.label(class="form-label") }}
            {{ form.devise(class="form-select", id="devise") }}
          </div>

          <div class="col-md-6 row-forfait">
            {{ form.montant_forfait.label(class="form-label") }}
            {{ form.montant_forfait(class="form-control", id="montant_forfait") }}
          </div>

          <div class="col-md-4 row-horaire">
            {{ form.heure_debut.label(class="form-label") }}
            {{ form.heure_debut(class="form-control", id="heure_debut") }}
          </div>
          <div class="col-md-4 row-horaire">
            {{ form.heure_fin.label(class="form-label") }}
            {{ form.heure_fin(class="form-control", id="heure_fin") }}
          </div>
          <div class="col-md-4 row-horaire">
            {{ form.taux_horaire.label(class="form-label") }}
            {{ form.taux_horaire(class="form-control", id="taux_horaire") }}
          </div>

          <div class="col-md-4">
            {{ form.date.label(class="form-label") }}
            {{ form.date(class="form-control") }}
          </div>

          <div class="col-md-12">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows=2) }}
          </div>

          <div class="col-md-6">
            {{ form.dossier_id.label(class="form-label") }}
            {{ form.dossier_id(class="form-select select2-ajax") }}
          </div>

          <div class="col-md-6">
            {{ form.tva_applicable.label(class="form-label") }}
            {{ form.tva_applicable(class="form-select", id="tva_applicable") }}
          </div>

          <div class="col-md-6">
            {{ form.statut.label(class="form-label") }}
            {{ form.statut(class="form-select") }}
          </div>

          <div class="col-md-4">
            <label>Dur√©e estim√©e :</label>
            <p id="duree_affichee" class="form-control-plaintext">-</p>
          </div>
          <div class="col-md-4">
            <label>Montant HT :</label>
            <p id="montant_ht" class="form-control-plaintext">-</p>
          </div>
          <div class="col-md-4">
            <label>Montant TTC :</label>
            <p id="montant_ttc" class="form-control-plaintext">-</p>
          </div>
        </div>
        <div class="modal-footer">
          {{ form.submit(class="btn btn-success") }}
        </div>
      </form>
    </div>
  </div>
</div>

{# Modal d√©tail (inchang√© sauf unit√© dynamique c√¥t√© JS) #}
<div class="modal fade" id="detailTimesheetModal" tabindex="-1" aria-labelledby="detailTimesheetLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="detailTimesheetLabel">D√©tail du Timesheet</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="card h-100 shadow-sm border-light">
              <div class="card-body">
                <h6 class="card-title text-primary"><i class="bi bi-calendar-check me-2"></i>Informations g√©n√©rales</h6>
                <hr>
                <p class="card-text mb-1"><strong>Client :</strong> <span id="detail-client"></span></p>
                <p class="card-text mb-1"><strong>Dossier :</strong> <span id="detail-dossier"></span></p>
                <p class="card-text mb-1"><strong>Date :</strong> <span id="detail-date"></span></p>
                <p class="card-text mb-1"><strong>D√©but :</strong> <span id="detail-debut"></span></p>
                <p class="card-text mb-1"><strong>Fin :</strong> <span id="detail-fin"></span></p>
                <p class="card-text mb-0"><strong>Dur√©e :</strong> <span id="detail-duree" class="text-success fw-bold"></span></p>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="card h-100 shadow-sm border-light">
              <div class="card-body">
                <h6 class="card-title text-primary"><i class="bi bi-currency-exchange me-2"></i>D√©tails financiers</h6>
                <hr>
                <p class="card-text mb-1"><strong>Taux horaire :</strong> <span id="detail-taux" class="text-info"></span></p>
                <p class="card-text mb-1"><strong>Montant HT :</strong> <span id="detail-ht" class="text-success fw-bold"></span></p>
                <p class="card-text mb-1"><strong>Montant TTC :</strong> <span id="detail-ttc" class="text-success fw-bold"></span></p>
                <p class="card-text mb-0"><strong>Statut :</strong> <span id="detail-statut" class="badge bg-secondary"></span></p>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card shadow-sm border-light">
              <div class="card-body">
                <h6 class="card-title text-primary"><i class="bi bi-text-left me-2"></i>Description</h6>
                <hr>
                <p id="detail-description" class="text-muted fst-italic"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a id="editTimesheetLink" class="btn btn-outline-primary">Modifier</a>
        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

{# Modal confirmation suppression #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
        <button type="button" class="btn btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        √ätes-vous s√ªr de vouloir supprimer ce timesheet ? Cette action est irr√©versible.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form id="deleteTimesheetForm" method="POST" style="display:inline;">
          {{ delete_form.hidden_tag() }}
          <button type="submit" class="btn btn-danger">Supprimer</button>
        </form>
      </div>
    </div>
  </div>
</div>

{# Menu contextuel #}
<div id="context-menu" class="shadow rounded" style="display: none; position: absolute; z-index: 9999; background-color: white; border: 1px solid #ccc; padding: 5px;">
  <ul class="list-unstyled m-0">
    <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
    <li><a href="#" id="exportPDF" class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
    <li><a href="#" id="printTable" class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
  </ul>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

<link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>

<link  href="https://cdn.datatables.net/rowgroup/1.3.1/css/rowGroup.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/rowgroup/1.3.1/js/dataTables.rowGroup.min.js"></script>

<script>
(function () {
  "use strict";
  (function compactTimesheets() {
  const css = `
    /* police et paddings plus petits */
    #timesheetsTable thead th,
    #timesheetsTable tbody td{
      font-size:12px !important;
      padding:4px 6px !important;
      line-height:1.1 !important;
    }
    /* badges (Type, Statut) plus petits */
    #timesheetsTable .badge{
      font-size:10px !important;
      padding:.15rem .35rem !important;
    }
    /* tout sur une ligne pour gagner de la place... */
    #timesheetsTable th, #timesheetsTable td{ white-space:nowrap; }
    /* ...sauf la colonne Dossier qui peut se mettre sur 2-3 lignes */
    #timesheetsTable th:nth-child(6),
    #timesheetsTable td:nth-child(6){
      white-space:normal !important;
      max-width:240px;              /* ajuste si tu veux plus/moins */
    }
  `;
  const style = document.createElement('style');
  style.id = 'timesheets-compact-css';
  style.textContent = css;
  document.head.appendChild(style);

  // recalcul DataTables pour appliquer les nouvelles largeurs
  if (window.jQuery && $('#timesheetsTable').length && typeof dt !== 'undefined') {
    setTimeout(() => dt.columns.adjust().draw(false), 0);
  }
})();
  
  // ---------------- Utils ----------------
  function currencyLabelFrom(code) {
    if (code === 'EUR') return '‚Ç¨';
    if (code === 'USD') return '$';
    return 'FCFA';
  }

  function showTimesheetDetail(row) {
    const id   = row.dataset.id;
    const typ  = row.dataset.type || 'horaire';
    const unit = currencyLabelFrom(row.dataset.devise || 'XOF');
    const setText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

    setText('detail-client',      row.dataset.client || '‚Äî');
    setText('detail-dossier',     row.dataset.dossier || '‚Äî');
    setText('detail-date',        row.dataset.date || '‚Äî');
    setText('detail-statut',      row.dataset.statut || '‚Äî');
    setText('detail-description', row.dataset.description || '');

    if (typ === 'forfait') {
      setText('detail-debut','‚Äî'); setText('detail-fin','‚Äî');
      setText('detail-duree','‚Äî'); setText('detail-taux','‚Äî');
    } else {
      setText('detail-debut', row.dataset.heure_debut || '‚Äî');
      setText('detail-fin',   row.dataset.heure_fin   || '‚Äî');
      setText('detail-duree', row.dataset.duree_heures ? row.dataset.duree_heures + ' h' : '‚Äî');
      setText('detail-taux',  row.dataset.taux_horaire ? row.dataset.taux_horaire + ' ' + unit : '‚Äî');
    }
    setText('detail-ht',  row.dataset.montant_ht  ? row.dataset.montant_ht  + ' ' + unit : '‚Äî');
    setText('detail-ttc', row.dataset.montant_ttc ? row.dataset.montant_ttc + ' ' + unit : '‚Äî');

    const editLink = document.getElementById('editTimesheetLink');
    const delForm  = document.getElementById('deleteTimesheetForm');
    if (editLink) editLink.href = "/edit_timesheet/" + id;
    if (delForm)  delForm.action = '/timesheet/delete/' + id;

    const modalEl = document.getElementById('detailTimesheetModal');
    if (modalEl && window.bootstrap?.Modal) new bootstrap.Modal(modalEl).show();
  }
  window.showTimesheetDetail = showTimesheetDetail;

  // ---------------- Page init ----------------
  document.addEventListener('DOMContentLoaded', function () {
    const $ = window.jQuery;
    if (!$) return;
    const $table = $('#timesheetsTable');
    if (!$table.length) return;

    // --- Mise en page 2 colonnes : gauche √©largie au d√©part ---
    const $host   = $table.parent();
    const $layout = $('<div id="tsTwoPane" class="row g-3 align-items-start position-relative"></div>');
    const $left   = $('<div id="clientsPane" class="col-12 col-lg-5 col-xl-4"></div>');
    const $right  = $('<div id="tablePane"   class="col-12 col-lg-7 col-xl-8"></div>');
    $layout.append($left, $right);
    $host.prepend($layout);
    $right.append($table);
    
    /* ====== TOPBAR PRO + CARTE TABLEAU ====== */

    // 1) Barre de titre + actions
    const $topbar = $(`
      <div id="tsTopbar"
          class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <h2 class="h4 m-0 text-primary d-flex align-items-center">
          <i class="bi bi-clock-history me-2"></i> Gestion des Timesheets
        </h2>
        <div id="tsActions" class="d-flex align-items-center gap-2"></div>
      </div>
    `);
    // ins√©rer la topbar au-dessus des deux panneaux
    $layout.before($topbar);

    // 2) D√©placer le bouton "Ajouter un timesheet" dans la topbar (on r√©utilise le tien)
    const $addBtn = $('[data-bs-target="#ajoutTimesheetModal"]').first();
    if ($addBtn.length) {
      $addBtn.removeClass('btn-lg shadow'); // style plus sobre
      $addBtn.addClass('btn-success');
      $('#tsActions').append($addBtn);
    }
    // (optionnel) tu peux ajouter d'autres actions dans #tsActions plus tard

    // 3) Style ‚Äúcarte‚Äù pour le tableau c√¥t√© droit
    //   -> on enveloppe le wrapper DataTables dans une card pour un rendu clean
    setTimeout(() => {
      const $dtWrapNow = $('#timesheetsTable').closest('.dataTables_wrapper');
      if ($dtWrapNow.length && !$dtWrapNow.parent().is('#tsTableCard')) {
        $dtWrapNow.wrap('<div id="tsTableCard" class="card shadow-sm border-0"></div>');
        $dtWrapNow.addClass('p-2');  // petit padding int√©rieur
      }
    }, 0);

    // 4) Layout affin√© (largeurs responsive plus pro)
    $('#clientsPane').removeClass('col-lg-5 col-xl-4').addClass('col-12 col-lg-4 col-xl-3');
    $('#tablePane').removeClass('col-lg-7 col-xl-8').addClass('col-12 col-lg-8 col-xl-9');

    /* ====== CSS de finition ====== */
    const proCSS = `
      /* Topbar compacte et nette */
      #tsTopbar { padding: .25rem .25rem 0; }

      /* Carte du tableau : fond blanc sur ton fond vert */
      #tsTableCard { background: #ffffff; border-radius: .5rem; }
      #tsTableCard .dataTables_wrapper { padding: .5rem; }

      /* Hauteurs coh√©rentes et espacements */
      #clientsPane .card { margin-bottom: 0; }
      #tablePane > #emptyState { margin: 0; }

      /* Petite retouche du bouton flottant fl√®che si pr√©sent */
      #clientsHandle { box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    `;
    $('<style id="ts-pro-polish">').text(proCSS).appendTo(document.head);

    // --- Styles (inclut le mode repli√© + poign√©e) ---
    $('<style>\
      #tsTwoPane > [class*="col-"]{transition:all .25s ease}\
      #clientsPane .card{position:sticky; top:.75rem}\
      #clientsList .list-group-item{cursor:pointer}\
      #clientsList .list-group-item.active{background:#e8f0ff; color:#0d6efd; border-color:#cfe2ff}\
      #clientsBadge{font-size:.75rem}\
      /* rail repli√© */\
      #clientsPane.collapsed{flex:0 0 42px; max-width:42px}\
      #clientsPane.collapsed .card{display:none}\
      /* poign√©e */\
      #clientsHandle{position:sticky; top:.75rem; z-index:5; width:36px; height:36px; border-radius:999px; \
        display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #dee2e6; \
        box-shadow:0 2px 8px rgba(0,0,0,.08); cursor:pointer}\
      /* wrapper table : scroll horizontal propre */\
      #tablePane .dataTables_wrapper{overflow-x:auto}\
    </style>').appendTo(document.head);
    
    /* ===== Largeurs : Clients PLUS large / Tableau PLUS √©troit ===== */

    // LARGEURS CIBLE
    const LEFT_WIDE   = 'col-12 col-lg-5 col-xl-4'; // ~41% (lg) / 33% (xl) -> plus large
    const RIGHT_NARROW= 'col-12 col-lg-7 col-xl-8'; // ~59% (lg) / 67% (xl) -> plus √©troit

    // Nettoie d‚Äô√©ventuelles classes anciennes puis applique
    $('#clientsPane')
    .removeClass('col-lg-3 col-xl-2 col-lg-4 col-xl-3 col-lg-5 col-xl-4 collapsed') // nettoie
    .addClass(LEFT_WIDE);

    $('#tablePane')
    .removeClass('col-12 col-lg-8 col-xl-9 col-lg-9 col-xl-10 col-lg-7 col-xl-8') // nettoie
    .addClass(RIGHT_NARROW);

    // D√©cale un peu le panneau droit vers le bas pour respirer
    (() => {
    const id = 'ts-spacing-fix';
    if (!document.getElementById(id)) {
      const css = `
        #tablePane{ margin-top:.75rem; }
        @media (min-width:1200px){ #tablePane{ margin-top:1rem; } }
      `;
      const style = document.createElement('style');
      style.id = id; style.textContent = css; document.head.appendChild(style);
    }
    })();

    /* ===== Poign√©e : repli / d√©pli avec ces nouvelles largeurs ===== */
    function setWide(){
    $('#clientsPane').removeClass('collapsed').addClass(LEFT_WIDE);
    $('#tablePane').removeClass('col-12').addClass(RIGHT_NARROW);
    $('#clientsHandle').text('‚Äπ').attr('title','R√©duire la liste des clients');
    }
    function setCollapsed(){
    $('#clientsPane').addClass('collapsed');       // rail fin √† gauche
    $('#tablePane').removeClass(RIGHT_NARROW).addClass('col-12'); // table pleine largeur
    $('#clientsHandle').text('‚Ä∫').attr('title','Afficher la liste des clients');
    }

    // Remplace proprement toute ancienne version
    window.togglePane = function(forceCollapse){
    const shouldCollapse = (forceCollapse !== undefined)
      ? !!forceCollapse
      : !$('#clientsPane').hasClass('collapsed');
    if (shouldCollapse) setCollapsed(); else setWide();
    // recalcule DataTables si la table est visible
    try { setTimeout(()=> dt?.columns?.adjust()?.draw(false), 0); } catch(_) {}
    };

    // Rebranche le clic de la poign√©e
    $('#clientsHandle').off('click').on('click', ()=> window.togglePane());


    // --- Agr√©gations clients pour la colonne gauche ---
    const aggregate = new Map(); // name -> {count, heures, ht, ttc}
    $('#timesheetsTable tbody tr.ts-row').each(function(){
      const name   = this.dataset.client || '';
      if (!name) return;
      const heures = parseFloat((this.dataset.duree_heures || '0').replace(',', '.')) || 0;
      const ht     = parseFloat((this.dataset.montant_ht   || '0').replace(',', '.')) || 0;
      const ttc    = parseFloat((this.dataset.montant_ttc  || '0').replace(',', '.')) || 0;
      const acc = aggregate.get(name) || { count:0, heures:0, ht:0, ttc:0 };
      acc.count += 1; acc.heures += heures; acc.ht += ht; acc.ttc += ttc;
      aggregate.set(name, acc);
    });
    const totalRows = Array.from(aggregate.values()).reduce((s,v)=>s+v.count,0);
    const fmt = n => new Intl.NumberFormat('fr-FR').format(Math.round(n*100)/100);

    // --- Poign√©e (fl√®che) + Carte Clients ---
    const $handle = $('<button id="clientsHandle" class="btn btn-light btn-sm" aria-label="R√©duire/afficher la liste">‚Äπ</button>');
    const $card = $(`
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <strong>Clients</strong>
          <span id="clientsBadge" class="badge bg-secondary">${aggregate.size}</span>
        </div>
        <div class="card-body p-2">
          <input type="search" id="clientsFilter" class="form-control form-control-sm mb-2" placeholder="Filtrer un client‚Ä¶">
          <ul id="clientsList" class="list-group list-group-flush small"></ul>
        </div>
      </div>
    `);
    $left.append($handle, $card);

    const $list = $card.find('#clientsList');
    $list.append(`<li class="list-group-item d-flex justify-content-between align-items-center active" data-name="__ALL__">
                    <span>üü¢ Tous les clients</span>
                    <span class="badge bg-dark">${totalRows}</span>
                  </li>`);
    Array.from(aggregate.entries()).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([name, v])=>{
      $list.append(`
        <li class="list-group-item d-flex justify-content-between align-items-center" data-name="${$('<div>').text(name).html()}">
          <div class="me-2 text-truncate" title="${$('<div>').text(name).html()}">${$('<div>').text(name).html()}</div>
          <div class="text-nowrap">
            <span class="badge bg-primary me-1" title="# lignes">${v.count}</span>
            <span class="badge bg-success me-1" title="HT">${fmt(v.ht)} FCFA</span>
            <span class="badge bg-info text-dark" title="Heures">${fmt(v.heures)} h</span>
          </div>
        </li>`);
    });
    /* --- 1) Ajouter "Aucun client" + bouton R√©initialiser --- */
    $list.prepend(`
      <li id="clientsNone"
          class="list-group-item d-flex justify-content-between align-items-center active"
          data-name="__NONE__">
        <span>üö´ Aucun client</span>
        <span class="badge bg-secondary">‚Äî</span>
      </li>
    `);
    $list.find('li[data-name="__ALL__"]').removeClass('active');  // "Aucun" devient l‚Äô√©tat initial

    // petit bouton pratique au-dessus du champ de filtre
    $('<button type="button" id="resetClientsBtn" class="btn btn-sm btn-outline-secondary w-100 mb-2">‚Ü© R√©initialiser</button>')
      .insertBefore('#clientsFilter');
  
  
    /* --- 2) Fonction de r√©initialisation (retour √† l‚Äô√©tat de d√©part) --- */
    function resetToInitial(){
      // 2.1  enlever tout filtre c√¥t√© DataTables
      dt.column(COL_CLIENT).search('').draw();

      // 2.2  remettre la s√©lection dans la liste
      $('#clientsList li').removeClass('active');
      $('#clientsNone').addClass('active');

      // 2.3  masquer le tableau et r√©-afficher le placeholder
      $dtWrap.hide();
      $placeholder.show();

      // 2.4  r√©-ouvrir le panneau de gauche (si repli√©)
      $('#clientsPane').removeClass('collapsed');
      $('#tablePane').removeClass('col-12').addClass('col-lg-7 col-xl-8');
      $handle.text('‚Äπ').attr('title','R√©duire la liste des clients');

      // 2.5  recalage des colonnes si besoin
      setTimeout(()=> dt.columns.adjust(), 0);
    }

    /* --- 3) Brancher le bouton et la touche ESC --- */
    $('#resetClientsBtn').on('click', resetToInitial);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') resetToInitial(); });

    /* --- 4) √âtendre ton gestionnaire de clics sur la liste --- */
    // (remplace ton gestionnaire existant ou adapte-le ainsi)
    $('#clientsList').off('click').on('click', 'li', function(){
      $('#clientsList li').removeClass('active');
      $(this).addClass('active');

      const name = this.dataset.name;

      // cas 4.1 : retour √† z√©ro
      if (name === '__NONE__') {
        resetToInitial();
        return;
      }

      // cas 4.2 : tous les clients (tableau visible, sans filtre)
      if (name === '__ALL__') {
        showTablePaneOnce();
        dt.column(COL_CLIENT).search('').draw();
        return;
      }

      // cas 4.3 : un client pr√©cis (tableau visible + filtre)
      showTablePaneOnce();
      dt.column(COL_CLIENT).search('^' + escapeRegex(name) + '$', true, false).draw();
    });

     /* ===== Filtre clients robuste (accent-insensible) ===== */
    /* ===== Filtre clients fiable (accent-insensible) ===== */
  (function () {
    // normalisation: minuscules, accents retir√©s, espaces compact√©s
    const norm = s => (s || '')
      .toString()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, ' ')
      .trim();

    function applyClientsFilter(q) {
      const needle = norm(q);
      $('#clientsList .list-group-item').each(function () {
        const $li = $(this);
        const nameAttr = this.dataset.name || '';
        // ces entr√©es restent visibles
        if (nameAttr === '__NONE__' || nameAttr === '__ALL__') { $li.show(); return; }

        // on cherche sur dataset + texte affich√© (s√©curit√©)
        const hay = norm(nameAttr + ' ' + $li.text());
        $li.toggle(needle === '' || hay.includes(needle));
      });
    }

    // On enl√®ve toute ancienne liaison puis on attache en d√©l√©gu√© (robuste)
    $(document)
      .off('.clientsFilter') // retire input/search/keyup pr√©c√©dents si pr√©sents
      .on('input.clientsFilter search.clientsFilter keyup.clientsFilter', '#clientsFilter', function (e) {
        // Enter: si tu veux s√©lectionner automatiquement le 1er visible, d√©commente le bloc plus bas
        applyClientsFilter(this.value);
        
        if (e.type === 'keyup' && e.key === 'Enter') {
          const $first = $('#clientsList .list-group-item')
            .filter(function(){
              const n = this.dataset.name || '';
              return n !== '__NONE__' && n !== '__ALL__' && $(this).is(':visible');
            }).first();
          if ($first.length) $first.click();
        }
        
      });

    // applique si l‚Äôinput a d√©j√† une valeur au chargement
    const initVal = $('#clientsFilter').val();
    if (initVal) applyClientsFilter(initVal);
  })();

    // --- DataTable (avec scroll horizontal pour √©viter le d√©bordement) ---
    //    -> responsive d√©sactiv√© pour un rendu stable + scrollX
    const dt = $('#timesheetsTable').DataTable({
      autoWidth: false,
      responsive: false,
      scrollX: false,
      dom: 'frtip',
      buttons: ['excel', 'pdf', 'print'],
      select: { style: 'multi' },
      language: {
        search: "üîç Rechercher :", lengthMenu: "Afficher _MENU_ entr√©es",
        info: "Affichage de _START_ √† _END_ sur _TOTAL_ entr√©es",
        infoEmpty: "Affichage de 0 √† 0 sur 0 entr√©e",
        infoFiltered: "(filtr√© de _MAX_ entr√©es totales)",
        paginate: { previous: "Pr√©c√©dent", next: "Suivant" },
        zeroRecords: "Aucun timesheet trouv√©"
      }
    });

    // Indice de la colonne "Client"
    const ths2 = $table.find('thead th');
    let COL_CLIENT = 0;
    ths2.each(function(i){ if ($(this).text().trim().toLowerCase() === 'client') COL_CLIENT = i; });

    // --- √âtat vide au d√©part : on masque le tableau jusqu'au 1er clic ---
    const $placeholder = $(`
      <div id="emptyState" class="card shadow-sm border-0 bg-light-subtle">
        <div class="card-body text-center py-5">
          <div class="display-6 mb-2">üëà</div>
          <h5 class="mb-1">S√©lectionnez un client</h5>
          <p class="text-muted mb-0">Ses timesheets appara√Ætront ici.</p>
        </div>
      </div>`);
    $right.append($placeholder);

    const $dtWrap = $('#timesheetsTable').closest('.dataTables_wrapper');
    $dtWrap.hide();

    function columnsFix(){ setTimeout(()=> dt.columns.adjust().draw(false), 0); }

    // Poign√©e : bascule repli/affichage de la colonne de gauche
    function togglePane(forceCollapse){
      const collapsed = (forceCollapse !== undefined)
        ? !!forceCollapse
        : !$('#clientsPane').hasClass('collapsed');

      if (collapsed) {
        $('#clientsPane').addClass('collapsed');
        $('#tablePane').removeClass('col-lg-7 col-xl-8').addClass('col-12');
        $handle.text('‚Ä∫').attr('title','Afficher la liste des clients');
      } else {
        $('#clientsPane').removeClass('collapsed');
        $('#tablePane').removeClass('col-12').addClass('col-lg-7 col-xl-8');
        $handle.text('‚Äπ').attr('title','R√©duire la liste des clients');
      }
      columnsFix();
    }
    $handle.on('click', ()=> togglePane()); // clic manuel

    // Affiche le tableau (1√®re fois) et replie la colonne gauche
    function showTablePaneOnce(){
      if ($dtWrap.is(':hidden')) {
        $placeholder.hide();
        $dtWrap.show();
        columnsFix();
      }
      // Replie automatiquement pour faire de la place
      togglePane(true);
    }

    // Clic sur un client
    function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    $('#clientsList').on('click', 'li', function(){
      $('#clientsList li').removeClass('active');
      $(this).addClass('active');

      const name = this.dataset.name;
      showTablePaneOnce();

      if (!name || name === '__ALL__') {
        dt.column(COL_CLIENT).search('').draw();
        return;
      }
      dt.column(COL_CLIENT).search('^' + escapeRegex(name) + '$', true, false).draw();
    });

    // ------- (Ton code de s√©lection & menu contextuel) -------
    const $container = $(dt.table().container());
    function syncCheckboxes() {
      dt.rows({ page: 'current' }).every(function () {
        const node = this.node();
        const cb = $(node).find('input.row-check').get(0);
        if (cb) cb.checked = this.selected();
      });
    }
    function updateCheckAllState() {
      const total = dt.rows({ search: 'applied' }).count();
      const selected = dt.rows({ search: 'applied', selected: true }).count();
      const allChecked = (total > 0 && selected === total);
      const indet = (selected > 0 && selected < total);
      $container.find('thead input#check-all').each(function () {
        this.checked = allChecked;
        this.indeterminate = indet;
      });
    }
    $container.on('change', 'thead input#check-all', function () {
      if (this.checked) dt.rows({ search: 'applied' }).select();
      else dt.rows({ search: 'applied' }).deselect();
      syncCheckboxes(); updateCheckAllState();
    });
    $('#timesheetsTable tbody').on('click', 'input.row-check', function (e) {
      e.stopPropagation();
      const row = dt.row($(this).closest('tr'));
      if (this.checked) row.select(); else row.deselect();
      updateCheckAllState();
    });
    dt.on('select deselect', function (e, dtx, type, indexes) {
      if (type === 'row') {
        indexes.forEach(idx => {
          const node = dtx.row(idx).node();
          const cb = $(node).find('input.row-check').get(0);
          if (cb) cb.checked = dtx.row(idx).selected();
        });
        updateCheckAllState();
      }
    });
    dt.on('draw', function () { syncCheckboxes(); updateCheckAllState(); });

    $('#timesheetsTable tbody').on('contextmenu', 'tr', function (e) {
      e.preventDefault();
      const row = dt.row(this);
      if (!row.selected()) {
        row.select();
        $(this).find('input.row-check').prop('checked', true);
        updateCheckAllState();
      }
      $('#context-menu').css({ top: e.pageY + 'px', left: e.pageX + 'px' }).show();
    });
    $(document).on('click', function () { $('#context-menu').hide(); });

    function needSelectionOrWarn(action) {
      const count = dt.rows({ selected: true }).count();
      if (count === 0) { alert('S√©lectionnez au moins un timesheet (cochez les cases) avant d‚Äôexporter.'); return; }
      action();
    }
    $('#exportExcel').on('click', e => { e.preventDefault(); needSelectionOrWarn(() => dt.button('.buttons-excel').trigger()); });
    $('#exportPDF')  .on('click', e => { e.preventDefault(); needSelectionOrWarn(() => dt.button('.buttons-pdf').trigger()); });
    $('#printTable') .on('click', e => { e.preventDefault(); needSelectionOrWarn(() => dt.button('.buttons-print').trigger()); });

    // ------- Calculs formulaire (inchang√©) -------
    const typeSelect     = document.getElementById('type_facturation');
    const rowHoraire     = document.querySelectorAll('.row-horaire');
    const rowForfait     = document.querySelectorAll('.row-forfait');
    const heureDebut     = document.getElementById('heure_debut');
    const heureFin       = document.getElementById('heure_fin');
    const tauxHoraire    = document.getElementById('taux_horaire');
    const montantForfait = document.getElementById('montant_forfait');
    const selectedUnit = () => {
      const sel = document.getElementById('devise');
      return currencyLabelFrom(sel?.value || 'XOF');
    };
    function toggleFields() {
      const isForfait = typeSelect && typeSelect.value === 'forfait';
      rowHoraire.forEach(el => el.style.display = isForfait ? 'none' : '');
      rowForfait.forEach(el => el.style.display = isForfait ? '' : 'none');
      if (heureDebut)      heureDebut.required      = !isForfait;
      if (heureFin)        heureFin.required        = !isForfait;
      if (tauxHoraire)     tauxHoraire.required     = !isForfait;
      if (montantForfait)  montantForfait.required  =  isForfait;
      calculerDureeEtMontants();
    }
    function calculerDureeEtMontants() {
      const tvaSelect = document.getElementById('tva_applicable');
      const tvaVal = tvaSelect?.options[tvaSelect.selectedIndex]?.value;
      const tvaRate = 0.18;
      const unit = selectedUnit();
      const set = (id, txt) => { const el = document.getElementById(id); if (el) el.innerText = txt; };

      if (typeSelect && typeSelect.value === 'forfait') {
        const forfait = parseFloat((montantForfait?.value || '0').replace(',', '.')) || 0;
        if (forfait > 0) {
          const ht = forfait;
          const ttc = (tvaVal === 'oui') ? Math.round(ht * (1 + tvaRate) * 100) / 100 : ht;
          set('duree_affichee', "‚Äî"); set('montant_ht',  ht.toFixed(2)  + " " + unit); set('montant_ttc', ttc.toFixed(2) + " " + unit);
          return;
        }
        set('duree_affichee', "-"); set('montant_ht', "-"); set('montant_ttc', "-"); return;
      }
      const debut = heureDebut?.value, fin = heureFin?.value;
      const taux  = parseFloat(tauxHoraire?.value?.replace(',', '.') || '0') || 0;
      if (debut && fin && taux >= 0) {
        const [h1, m1] = debut.split(':').map(Number);
        const [h2, m2] = fin.split(':').map(Number);
        let dureeMin = (h2*60+m2) - (h1*60+m1);
        if (dureeMin < 0) dureeMin += 24*60;
        const dureeH = Math.round((dureeMin/60)*100)/100;
        const ht  = Math.round(dureeH * taux * 100) / 100;
        const ttc = (tvaVal === 'oui') ? Math.round(ht * (1 + tvaRate) * 100) / 100 : ht;
        set('duree_affichee', dureeH.toFixed(2) + " h");
        set('montant_ht',  ht.toFixed(2)  + " " + unit);
        set('montant_ttc', ttc.toFixed(2) + " " + unit);
      } else {
        set('duree_affichee', "-"); set('montant_ht', "-"); set('montant_ttc', "-");
      }
    }
    if (typeSelect) typeSelect.addEventListener('change', toggleFields);
    ['heure_debut','heure_fin','taux_horaire','montant_forfait','tva_applicable','devise'].forEach(id => {
      const el = document.getElementById(id); if (!el) return;
      const evt = (id === 'tva_applicable' || id === 'devise') ? 'change' : 'input';
      el.addEventListener(evt, calculerDureeEtMontants);
    });
    toggleFields(); calculerDureeEtMontants();
  (function () {
  const css = `
    /* th du tableau principal ET th du header clon√© (scrollX) */
    #tablePane .dataTables_wrapper table.dataTable > thead > tr > th,
    #tablePane .dataTables_wrapper div.dataTables_scrollHead table.dataTable > thead > tr > th{
      font-size: 10px !important;   /* ajuste 9‚Äì12 px selon ton go√ªt */
      padding: 3px 6px !important;
      line-height: 1.05 !important;
      vertical-align: middle !important;
      white-space: nowrap !important;
    }

    /* Pseudo-ic√¥nes de tri DataTables (Bootstrap) plus petites & rapproch√©es */
    #tablePane .dataTables_wrapper table.dataTable > thead .sorting:before,
    #tablePane .dataTables_wrapper table.dataTable > thead .sorting_asc:before,
    #tablePane .dataTables_wrapper table.dataTable > thead .sorting_desc:before,
    #tablePane .dataTables_wrapper table.dataTable > thead .sorting:after,
    #tablePane .dataTables_wrapper table.dataTable > thead .sorting_asc:after,
    #tablePane .dataTables_wrapper table.dataTable > thead .sorting_desc:after{
      font-size: .6rem !important;
      right: .25rem !important;
    }
  `;
  const style = document.createElement('style');
  style.id = 'ts-headers-only-compact';
  style.textContent = css;
  document.head.appendChild(style);
})();
    // Auto-hide flashs
    setTimeout(() => {
      document.querySelectorAll('#flash-messages .alert').forEach(el => {
        el.classList.remove('show'); el.classList.add('fade');
        setTimeout(() => el.remove(), 500);
      });
    }, 5000);
  });
})();

</script>
{% endblock %}



