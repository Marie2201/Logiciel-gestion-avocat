{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="container py-4 px-4 rounded shadow-sm" style="background-color: #e3f2fd;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary"><i class="bi bi-people-fill"></i> Gestion des Clients</h2>
            <button class="btn btn-primary shadow" data-bs-toggle="modal" data-bs-target="#ajoutClientModal">
                <i class="bi bi-plus-circle"></i> Ajouter un client
            </button>
        </div>

        <table id="timesheetsTable" 
               class="table table-striped table-bordered table-hover table-responsive rounded w-100 overflow-hidden" 
               style="background-color: #ffffff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">

            <thead class="table-primary text-dark">
                <tr>
                    <th>Soci√©t√©</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>Adresse</th>
                    <th>R√©f√©rent</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr class="client-row"
                    data-id="{{ client.id }}"
                    data-societe="{{ client.societe }}"
                    data-email="{{ client.email }}"
                    data-telephone="{{ client.telephone }}"
                    data-referent="{{ client.user.nom }}"
                    data-adresse="{{ client.adresse }}">
                    <td>{{ client.societe }}</td>
                    <td>{{ client.email }}</td>
                    <td>{{ client.telephone }}</td>
                    <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ client.adresse }}
                    </td>
                    <td>{{ client.user.nom }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Menu clic droit -->
<div id="context-menu" class="shadow rounded" style="display: none; position: absolute; z-index: 9999; background-color: white; border: 1px solid #ccc; padding: 5px;">
    <ul class="list-unstyled m-0">
        <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
        <li><a href="#" id="exportPDF" class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
        <li><a href="#" id="printTable" class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
    </ul>
</div>

<!-- Modal d'ajout -->
<div class="modal fade" id="ajoutClientModal" tabindex="-1" aria-labelledby="ajoutClientLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="ajoutClientLabel">Ajouter un client</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body row g-3">
            <div class="col-md-6">
                {{ form.societe.label(class="form-label") }}
                {{ form.societe(class="form-control") }}
            </div>
            <div class="col-md-6">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control") }}
            </div>
            <div class="col-md-6">
                {{ form.telephone.label(class="form-label") }}
                {{ form.telephone(class="form-control") }}
            </div>
            <div class="col-md-12">
                {{ form.adresse.label(class="form-label") }}
                {{ form.adresse(class="form-control") }}
            </div>
        </div>
        <div class="modal-footer">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal d√©tail client -->
<div class="modal fade" id="detailClientModal" tabindex="-1" aria-labelledby="detailClientLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="detailClientLabel">D√©tail du Client</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm border-0" style="background-color: #e3f2fd;">
                            <div class="card-body">
                                <h6 class="card-title text-primary"><i class="bi bi-building me-2"></i>Informations Soci√©t√©</h6>
                                <hr>
                                <p class="card-text mb-1"><strong>Soci√©t√© :</strong> <span id="detail-societe" class="fw-normal text-capitalize"></span></p>
                                <p class="card-text mb-1"><strong>Email :</strong> <span id="detail-email" class="fw-normal"></span></p>
                                <p class="card-text mb-0"><strong>T√©l√©phone :</strong> <span id="detail-telephone" class="fw-normal"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 shadow-sm border-light">
                            <div class="card-body">
                                <h6 class="card-title text-primary"><i class="bi bi-geo-alt me-2"></i>Adresse</h6>
                                <hr>
                                <p id="detail-adresse" class="card-text text-muted"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm border-light">
                            <div class="card-body">
                                <h6 class="card-title text-primary"><i class="bi bi-folder2-open me-2"></i>Dossiers Associ√©s</h6>
                                <hr>
                                <ul id="detail-dossiers" class="list-group list-group-flush mb-3"></ul>

                                <a id="voirDossiersBtn" class="btn btn-outline-primary" target="_blank">
                                    Voir tous les dossiers
                                </a>
                                <p class="text-muted small mb-0 mt-3">
                                  <i class="bi bi-info-circle me-1"></i>Cette liste affiche les dossiers li√©s √† ce client.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="editClientLink" class="btn btn-outline-primary">Modifier</a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{# Modal de confirmation de suppression (remplace confirm()) #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                √ätes-vous s√ªr de vouloir supprimer ce client ? Cette action est irr√©versible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteClientForm" method="POST" style="display:inline;">
                    {{ delete_form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>    
{% endblock %}


{% block scripts %}
<script>
$(document).ready(function () {
    const table = $('#clientsTable').DataTable({
        autoWidth: false,
        responsive: true,
        dom: 'frtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="bi bi-file-earmark-excel"></i> Exporter Excel',
                filename: 'clients_excel',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                }
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="bi bi-file-pdf"></i> Exporter PDF',
                filename: 'clients_pdf',
                orientation: 'landscape',
                pageSize: 'A4',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                }
            },
            {
                extend: 'print',
                text: '<i class="bi bi-printer"></i> Imprimer',
                exportOptions: {
                    columns: [0, 1, 2, 3]
                }
            }
        ],
        language: {
            search: "üîç Rechercher :",
            lengthMenu: "",
            info: "",
            infoEmpty: "",
            paginate: {
                previous: "Pr√©c√©dent",
                next: "Suivant"
            },
            zeroRecords: "Aucun client trouv√©"
        }
    });

    $('.client-row').on('dblclick', function () {
        const clientId = $(this).data('id');

        // Chargement dynamique via API
        fetch(`/client/${clientId}`)
            .then(response => response.json())
            .then(data => {
                $('#detail-societe').text(data.societe);
                $('#detail-email').text(data.email);
                $('#detail-telephone').text(data.telephone);
                $('#detail-adresse').text(data.adresse);

                // Remplit la liste des dossiers
                const dossierList = $('#detail-dossiers');
                dossierList.empty();

                if (data.dossiers && data.dossiers.length > 0) {
                    data.dossiers.forEach(d => {
                        dossierList.append(`<li class="list-group-item">${d.nom} (${d.statut})</li>`);
                    });
                } else {
                    dossierList.append('<li class="list-group-item text-muted">Aucun dossier associ√©</li>');
                }

                // Met √† jour les liens
                $('#editClientLink').attr('href', '/clients/modifier/' + clientId);
                $('#deleteClientForm').attr('action', '/clients/supprimer/' + clientId);
                $('#voirDossiersBtn').attr('href', '/dossiers?client_id=' + clientId);

                $('#detailClientModal').modal('show');
            });
    });

    $('#clientsTable tbody').on('contextmenu', 'tr', function (e) {
        e.preventDefault();
        $('#context-menu').css({ top: e.pageY + 'px', left: e.pageX + 'px' }).show();
    });

    $(document).on('click', function () {
        $('#context-menu').hide();
    });

    $('#exportExcel').on('click', function (e) {
        e.preventDefault();
        table.button('.buttons-excel').trigger();
    });

    $('#exportPDF').on('click', function (e) {
        e.preventDefault();
        table.button('.buttons-pdf').trigger();
    });

    $('#printTable').on('click', function (e) {
        e.preventDefault();
        table.button('.buttons-print').trigger();
    });

    setTimeout(() => {
        const alerts = document.querySelectorAll('#flash-messages .alert');
        alerts.forEach(el => {
            el.classList.remove('show');
            el.classList.add('fade');
            setTimeout(() => el.remove(), 500);
        });
    }, 5000);
});
</script>
{% endblock %}
