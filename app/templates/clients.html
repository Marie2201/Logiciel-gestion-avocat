{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="container py-4 px-4 rounded shadow-sm" style="background-color: #e3f2fd;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary"><i class="bi bi-people-fill"></i> Gestion des Clients</h2>
            <button class="btn btn-primary shadow" data-bs-toggle="modal" data-bs-target="#ajoutClientModal">
                <i class="bi bi-plus-circle"></i> Ajouter un client
            </button>
        </div>

        <table id="clientsTable" 
               class="table table-striped table-bordered table-hover table-responsive rounded w-100 overflow-hidden" 
               style="background-color: #ffffff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);">

            <thead class="table-primary text-dark">
                <tr>
                    <th>Client</th>
                    <th>Email</th>
                    <th>Téléphone</th>
                    <th>Adresse</th>
                    <th>Référent</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr class="client-row"
                    data-id="{{ client.id }}"
                    data-societe="{{ client.societe }}"
                    data-email="{{ client.email }}"
                    data-telephone="{{ client.telephone }}"
                    data-referent="{{ client.user.nom }}"
                    data-adresse="{{ client.adresse }}">
                    <td>{{ client.societe }}</td>
                    <td>{{ client.email }}</td>
                    <td>{{ client.telephone }}</td>
                    <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ client.adresse }}
                    </td>
                    <td>{{ client.user.nom }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Menu clic droit -->
<div id="context-menu" class="shadow rounded" style="display: none; position: absolute; z-index: 9999; background-color: white; border: 1px solid #ccc; padding: 5px;">
    <ul class="list-unstyled m-0">
        <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
        <li><a href="#" id="exportPDF" class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
        <li><a href="#" id="printTable" class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
    </ul>
</div>

<!-- Modal d'ajout -->
<div class="modal fade" id="ajoutClientModal" tabindex="-1" aria-labelledby="ajoutClientLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="ajoutClientLabel">Ajouter un client</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body row g-3">
            <div class="col-md-6">
                {{ form.societe.label(class="form-label") }}
                {{ form.societe(class="form-control") }}
            </div>
            <div class="col-md-6">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control") }}
            </div>
            <div class="col-md-6">
                {{ form.telephone.label(class="form-label") }}
                {{ form.telephone(class="form-control") }}
            </div>
            <div class="col-md-12">
                {{ form.adresse.label(class="form-label") }}
                {{ form.adresse(class="form-control") }}
            </div>
        </div>
        <div class="modal-footer">
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal détail client -->
<div class="modal fade" id="detailClientModal" tabindex="-1" aria-labelledby="detailClientLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="detailClientLabel">Détail du Client</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm border-0" style="background-color: #e3f2fd;">
                            <div class="card-body">
                                <h6 class="card-title text-primary"><i class="bi bi-building me-2"></i>Informations Client</h6>
                                <hr>
                                <p class="card-text mb-1"><strong>Client :</strong> <span id="detail-societe" class="fw-normal text-capitalize"></span></p>
                                <p class="card-text mb-1"><strong>Email :</strong> <span id="detail-email" class="fw-normal"></span></p>
                                <p class="card-text mb-0"><strong>Téléphone :</strong> <span id="detail-telephone" class="fw-normal"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 shadow-sm border-light">
                            <div class="card-body">
                                <h6 class="card-title text-primary"><i class="bi bi-geo-alt me-2"></i>Adresse</h6>
                                <hr>
                                <p id="detail-adresse" class="card-text text-muted"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm border-light">
                            <div class="card-body">
                                <h6 class="card-title text-primary"><i class="bi bi-folder2-open me-2"></i>Dossiers Associés</h6>
                                <hr>
                                <ul id="detail-dossiers" class="list-group list-group-flush mb-3"></ul>

                                <a id="voirDossiersBtn" class="btn btn-outline-primary" target="_blank">
                                    Voir tous les dossiers
                                </a>
                                <p class="text-muted small mb-0 mt-3">
                                  <i class="bi bi-info-circle me-1"></i>Cette liste affiche les dossiers liés à ce client.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="editClientLink" class="btn btn-outline-primary">Modifier</a>
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{# Modal de confirmation de suppression (remplace confirm()) #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer ce client ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteClientForm" method="POST" style="display:inline;">
                    {{ delete_form.hidden_tag() }}
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>    
{% endblock %}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables + Responsive + Buttons (optionnels mais recommandés) -->
<link  href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">
<link  href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css" rel="stylesheet">
<link  href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- Bootstrap 5 (bundle = Popper inclus) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% block scripts %}
<script>
(function () {
  const log = (...a) => console.log("[CLIENTS UI]", ...a);

  // Vérifs de base
  if (!window.jQuery) { console.error("jQuery manquant"); return; }
  const $ = window.jQuery;

  const $table = $('#clientsTable');
  if (!$table.length) { console.error("#clientsTable introuvable dans le DOM"); return; }

  // --- Barre de recherche + zone boutons (toujours visibles) ---
  if (!$('#clientsToolbar').length) {
    $table.before(`
      <div id="clientsToolbar" class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <div class="input-group" style="max-width:360px;">
          <span class="input-group-text">🔍</span>
          <input type="search" id="clientsSearch" class="form-control" placeholder="Rechercher un client…">
          <button class="btn btn-outline-secondary" id="clientsSearchClear" type="button" title="Effacer">&times;</button>
        </div>
        <div id="clientsButtons" class="text-md-end"></div>
      </div>
    `);
  }

  // --- DataTables (si présent), sinon fallback ---
  const hasDT = !!$.fn.DataTable;
  const hasButtons = hasDT && !!($.fn.dataTable && $.fn.dataTable.Buttons);
  let dt = null;

  if (hasDT) {
    try {
      dt = $table.DataTable({
        autoWidth: false,
        responsive: true,
        searching: true,
        dom: "rt" + "<'row align-items-center mt-3'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
        language: {
          zeroRecords: "Aucun client trouvé",
          paginate: { previous: "Précédent", next: "Suivant" },
          info: ""
        },
        buttons: hasButtons ? [
          { extend: 'excelHtml5', text: '<i class="bi bi-file-earmark-excel"></i> Exporter Excel', filename: 'clients_excel', exportOptions: { columns: [0,1,2,3] } },
          { extend: 'pdfHtml5',   text: '<i class="bi bi-file-pdf"></i> Exporter PDF',             filename: 'clients_pdf', orientation: 'landscape', pageSize: 'A4', exportOptions: { columns: [0,1,2,3] } },
          { extend: 'print',      text: '<i class="bi bi-printer"></i> Imprimer',                  exportOptions: { columns: [0,1,2,3] } }
        ] : []
      });
      if (hasButtons) dt.buttons().container().appendTo('#clientsButtons');
      log("DataTables OK", { rows: dt.rows().count(), buttons: hasButtons });
    } catch (e) {
      console.error("Échec init DataTables:", e);
    }
  } else {
    log("DataTables non chargé → mode fallback");
  }

  // --- Recherche (DataTables ou fallback) ---
  $('#clientsSearch').on('input', function () {
    const q = this.value;
    if (dt) dt.search(q).draw();
    else {
      const needle = q.trim().toLowerCase();
      $table.find('tbody tr').each(function () {
        const text = $(this).text().toLowerCase();
        $(this).toggle(text.indexOf(needle) !== -1);
      });
    }
  });
  $('#clientsSearchClear').on('click', function () {
    $('#clientsSearch').val('').trigger('input').trigger('focus');
  });

  // --- Utilitaire pour lignes "child" de DT Responsive ---
  function parentRow($tr) { return $tr.hasClass('child') ? $tr.prev('tr') : $tr; }

  // --- Double-clic pour ouvrir la modale détails (fallback sûr) ---
  $('#clientsTable tbody').on('dblclick', 'tr', function () {
    const $tr = parentRow($(this));
    const clientId = $tr.data('id') || $tr.attr('data-id');
    if (!clientId) { alert("ID client manquant sur la ligne."); log("Ligne sans data-id:", this); return; }

    fetch(`/client/${clientId}`)
      .then(r => r.json())
      .then(data => {
        $('#detail-societe').text(data.societe || '');
        $('#detail-email').text(data.email || '');
        $('#detail-telephone').text(data.telephone || '');
        $('#detail-adresse').text(data.adresse || '');
        const $list = $('#detail-dossiers').empty();
        (data.dossiers || []).forEach(d => $list.append(`<li class="list-group-item">${d.nom} (${d.statut || ''})</li>`));
        if (!$list.children().length) $list.append('<li class="list-group-item text-muted">Aucun dossier associé</li>');

        $('#editClientLink').attr('href', '/clients/modifier/' + clientId);
        $('#deleteClientForm').attr('action', '/clients/supprimer/' + clientId);
        $('#voirDossiersBtn').attr('href', '/dossiers?client_id=' + clientId);

        const modalEl = document.getElementById('detailClientModal');
        if (modalEl) new bootstrap.Modal(modalEl).show();
        else alert("Modale #detailClientModal introuvable dans le DOM.");
      })
      .catch(err => { console.error(err); alert("Erreur lors du chargement du client."); });
  });

  // --- Menu contextuel + export (fallback si Buttons absent) ---
  $('#clientsTable tbody').on('contextmenu', 'tr', function (e) {
    e.preventDefault();
    const $menu = $('#context-menu');
    if (!$menu.length) { log("#context-menu introuvable"); return; }
    $menu.css({ top: e.pageY, left: e.pageX, position: 'absolute', display: 'block' });
  });
  $(document).on('click', () => $('#context-menu').hide());

  $('#exportExcel').on('click', function (e) {
    e.preventDefault();
    if (dt && hasButtons) dt.button('.buttons-excel').trigger();
    else alert("Export Excel indisponible (extension Buttons non chargée).");
  });
  $('#exportPDF').on('click', function (e) {
    e.preventDefault();
    if (dt && hasButtons) dt.button('.buttons-pdf').trigger();
    else alert("Export PDF indisponible (extension Buttons non chargée).");
  });
  $('#printTable').on('click', function (e) {
    e.preventDefault();
    if (dt && hasButtons) dt.button('.buttons-print').trigger();
    else window.print();
  });

  // --- Petits styles utiles ---
  $('<style>#clientsTable tbody tr{cursor:pointer} #clientsToolbar .input-group-text{min-width:2.5rem; justify-content:center}</style>').appendTo(document.head);

  // --- Auto-hide des flashs ---
  setTimeout(() => {
    document.querySelectorAll('#flash-messages .alert').forEach(el => {
      el.classList.remove('show'); el.classList.add('fade');
      setTimeout(() => el.remove(), 500);
    });
  }, 5000);

  // --- Diagnostics finaux ---
  log("READY", {
    jQuery: $.fn.jquery,
    hasDT, hasButtons,
    rowsInDOM: $table.find('tbody tr').length
  });
})();
</script>
{% endblock %}
