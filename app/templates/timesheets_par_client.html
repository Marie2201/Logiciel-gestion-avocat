{% extends "base.html" %}
{% block title %}Timesheets par client{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="container py-4 px-4 rounded shadow-sm" style="background:#f7fbff;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-primary">üßë‚Äçüíº Timesheets ‚Äî Vue par client</h2>
      <a class="btn btn-outline-secondary" href="{{ url_for('timesheets') }}">
        Voir la liste d√©taill√©e
      </a>
    </div>

    <table id="clientsTimesheetsTable"
           class="table table-striped table-bordered table-hover w-100 shadow-sm rounded overflow-hidden"
           style="background:#fff;">
      <thead class="table-primary">
        <tr>
          <th>Client</th>
          <th># Timesheets</th>
          <th>Heures totales</th>
          <th>Montant HT</th>
          <th>Montant TTC</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr class="client-row" data-client-id="{{ r.client_id }}">
          <td>{{ r.client }}</td>
          <td>{{ r.nb_ts }}</td>
          <td>{{ '%.2f'|format(r.heures_total or 0) }} h</td>
          <td>{{ '%.2f'|format(r.ht_total or 0) }} FCFA</td>
          <td>{{ '%.2f'|format(r.ttc_total or 0) }} FCFA</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

{# Menu contextuel r√©utilisable (optionnel) #}
<div id="context-menu" class="shadow rounded" style="display:none; position:absolute; z-index:9999; background:#fff; border:1px solid #ccc; padding:5px;">
  <ul class="list-unstyled m-0">
    <li><a href="#" id="exportExcel" class="dropdown-item"><i class="bi bi-file-earmark-excel"></i> Exporter Excel</a></li>
    <li><a href="#" id="exportPDF"   class="dropdown-item"><i class="bi bi-file-pdf"></i> Exporter PDF</a></li>
    <li><a href="#" id="printTable"  class="dropdown-item"><i class="bi bi-printer"></i> Imprimer</a></li>
  </ul>
</div>
{% endblock %}

{% block scripts %}
<!-- si base.html ne les charge pas d√©j√†, sinon enl√®ve ces CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<link  href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<link  href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<script>
(function(){
  const $ = window.jQuery;
  if (!$) return;

  const dt = $('#clientsTimesheetsTable').DataTable({
    autoWidth: false,
    dom: 'Bfrtip',
    buttons: [
      { extend:'excelHtml5', text:'Excel', title:'Timesheets_par_client' },
      { extend:'pdfHtml5',   text:'PDF',   title:'Timesheets_par_client', orientation:'landscape', pageSize:'A4' },
      { extend:'print',      text:'Imprimer', title:'Timesheets par client' }
    ],
    order: [[0,'asc']],
    language: {
      search: "üîç Rechercher :", lengthMenu: "Afficher _MENU_ lignes",
      info: "_START_‚Äì_END_ sur _TOTAL_", infoEmpty: "0 r√©sultat",
      zeroRecords: "Aucun client", paginate: { previous: "Pr√©c√©dent", next: "Suivant" }
    },
    footerCallback: function(row, data){
      const api = this.api();
      const num = s => parseFloat(String(s).replace(/[^\d.,-]/g,'').replace(',','.')) || 0;

      const sumCol = idx => api.column(idx, {page:'current'}).data()
                              .reduce((a,v)=>a + num(v), 0);

      const totalHeures = sumCol(2);
      const totalHT     = sumCol(3);
      const totalTTC    = sumCol(4);

      $(api.column(1).footer()).html(api.column(1, {page:'current'}).data().reduce((a,v)=>a + (parseInt(v)||0), 0));
      $(api.column(2).footer()).html(totalHeures.toFixed(2) + ' h');
      $(api.column(3).footer()).html(totalHT.toFixed(2) + ' FCFA');
      $(api.column(4).footer()).html(totalTTC.toFixed(2) + ' FCFA');
    }
  });

  // Clic ligne ‚Üí redirection vers la page filtr√©e
  $('#clientsTimesheetsTable tbody').on('click', 'tr', function(){
    const id = this.dataset.clientId;
    if (!id) return;
    window.location.href = '/timesheets?client_id=' + id;
  });

  // Menu clic droit (optionnel)
  $('#clientsTimesheetsTable tbody').on('contextmenu', 'tr', function(e){
    e.preventDefault();
    $('#context-menu').css({ top:e.pageY+'px', left:e.pageX+'px' }).show();
  });
  $(document).on('click', function(){ $('#context-menu').hide(); });

  $('#exportExcel').on('click', e => { e.preventDefault(); dt.button('.buttons-excel').trigger(); });
  $('#exportPDF')  .on('click', e => { e.preventDefault(); dt.button('.buttons-pdf').trigger(); });
  $('#printTable') .on('click', e => { e.preventDefault(); dt.button('.buttons-print').trigger(); });

  // Cursor pointeur
  $('<style>#clientsTimesheetsTable tbody tr{cursor:pointer}</style>').appendTo(document.head);
})();
</script>
{% endblock %}
