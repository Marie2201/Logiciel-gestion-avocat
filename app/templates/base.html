<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#0d6efd">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}" type="image/png">

    <title>{% block title %}Myhouda{% endblock %}</title>

    <!-- Bootstrap / Icons / DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }

        /* Sidebar */
        .sidebar {
            height: 100vh;
            background-color: #343a40;
            padding: 1rem;
            position: fixed;
            width: 16.666667%; /* ~ col-md-2 */
            top: 0; left: 0;
            z-index: 1000;
        }
        .sidebar a {
            color: white; display: block; padding: 0.5rem; text-decoration: none;
            transition: background-color 0.2s;
        }
        .sidebar a:hover { background-color: #495057; }

        /* Main area: par d√©faut sans sidebar */
        .main { margin-left: 0; padding: 2rem; }
        /* Quand la sidebar est pr√©sente, on pousse le contenu */
        .has-sidebar .main { margin-left: 16.666667%; }

        .dataTables_filter { margin-bottom: 1rem !important; }
        #dossiersTable, #dossiersTable th, #dossiersTable td,
        #timesheetsTable, #timesheetsTable th, #timesheetsTable td {
            font-size: 0.85rem !important;
        }
        #flash-messages { margin-bottom: 1.5rem; }

        /* Dashboard cards */
        .dashboard-card { border: none; border-radius: 1rem; transition: all 0.3s ease; overflow: hidden; position: relative; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15) !important; }
        .dashboard-card .card-body { padding: 2rem; display: flex; flex-direction: column; justify-content: space-between; min-height: 150px; }
        .dashboard-card .card-icon { font-size: 3rem; color: rgba(255,255,255,.7); position: absolute; top: 1rem; right: 1.5rem; opacity: .2; z-index: 0; }
        .dashboard-card .card-title { font-size: 1.25rem; font-weight: 600; color: rgba(255,255,255,.9); z-index: 1; position: relative; }
        .dashboard-card .card-value { font-size: 2.5rem; font-weight: 700; color: #fff; z-index: 1; position: relative; }
        .bg-gradient-primary { background: linear-gradient(45deg, #007bff, #0056b3); }
        .bg-gradient-success { background: linear-gradient(45deg, #28a745, #1e7e34); }
        .bg-gradient-warning { background: linear-gradient(45deg, #ffc107, #d39e00); }
        .bg-gradient-info    { background: linear-gradient(45deg, #17a2b8, #117a8b); }
        .bg-gradient-danger  { background: linear-gradient(45deg, #dc3545, #b02a37); }

        .access-card { border: none; border-radius: .75rem; transition: all .2s; cursor: pointer; box-shadow: 0 .25rem .75rem rgba(0,0,0,.05); }
        .access-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.1); }
        .access-card .card-body { display: flex; align-items: center; gap: 15px; padding: 1.5rem; }
        .access-card .card-icon-lg { font-size: 2.5rem; color: var(--bs-primary); }
        .access-card .card-title-lg { font-size: 1.4rem; font-weight: 600; color: #333; }
        .access-card .card-text-sm { font-size: .9rem; color: #666; }

        .slide-in-top { animation: slideInTop .8s ease-out forwards; transform: translateY(-50px); opacity: 0; }
        @keyframes slideInTop { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .dropdown-menu-dark { background-color: #212529; }
        .dropdown-menu-dark .dropdown-item { color: #fff; }
        .dropdown-menu-dark .dropdown-item:hover { background-color: #343a40; }

        .username-text {
            max-width: 130px; display: inline-block; overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap; vertical-align: middle;
        }

        /* PWA helpers */
        #updatePwa {
            position: fixed; left: 50%; transform: translateX(-50%);
            bottom: 16px; background: #0d6efd; color: #fff;
            padding: 10px 14px; border-radius: 999px; display:none; z-index: 1080;
        }
        #updatePwa button{
            margin-left:8px;border:none;background:#fff;color:#0d6efd;
            padding:6px 10px;border-radius:999px;cursor:pointer
        }
        .brand-houda{ position: relative; display: inline-block; }
        .brand-sub{
        position: absolute;
        top: 90%;            /* juste sous "Houda" */
        left: 0.5;
        margin-top: .15rem;   /* petit espace */
        font-size: .5em;      /* plus petit que le titre */
        line-height: 1;
        text-transform: lowercase;
        color: rgba(255, 255, 255, 0.85); /* lisible sur fond sombre */
        }
                /* Turquoise / teal (gradient) */
        .bg-teal-gradient{
            background: linear-gradient(135deg, #20c997, #14b8b8 58%, #0aa29a);
        }
        /* Ic√¥ne en filigrane, comme les autres cartes */
        .kpi-bg-icon{
            font-size: 3rem;
            opacity: .18;
        }
        /* Chiffres bien align√©s */
        .kpi-card strong{ font-variant-numeric: tabular-nums; }

    </style>
</head>

<body class="{% if current_user.is_authenticated %}has-sidebar{% endif %}">
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <div class="container-fluid">
        <div class="row">
            {% if current_user.is_authenticated %}
            <!-- Sidebar visible uniquement si connect√© -->
            <nav class="col-md-2 sidebar">
                <h4 class="text-white mb-4 brand-title">
                My<span class="brand-houda">Houda<span class="brand-sub">S√©n√©gal</span></span>
                </h4>

                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <!--<li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-speedometer2 me-2"></i>Tableau de bord</a></li>-->
                    <li class="nav-item"><a class="nav-link" href="/clients"><i class="bi bi-people-fill me-2"></i>Clients</a></li>
                    <li class="nav-item"><a class="nav-link" href="/dossiers"><i class="bi bi-folder-fill me-2"></i>Dossiers</a></li>
                    <li class="nav-item"><a class="nav-link" href="/timesheets"><i class="bi bi-stopwatch-fill me-2"></i>Timesheets</a></li>
                    <li class="nav-item"><a class="nav-link" href="/factures"><i class="bi bi-receipt-cutoff me-2"></i>Factures</a></li>
                    <li class="nav-item"><a class="nav-link" href="/utilisateurs"><i class="bi bi-person-lines-fill me-2"></i>Utilisateurs</a></li>
                    
                    <li class="nav-item mt-5">
                        <div class="dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" role="button" id="profilMenu" data-bs-toggle="dropdown" aria-expanded="false" title="{{ current_user.nom }}">
                                <i class="bi bi-person-circle me-2"></i><span class="username-text">{{ current_user.nom }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="profilMenu">
                                <li><a class="dropdown-item" href="{{ url_for('changer_mdp') }}">üîê Modifier le mot de passe</a></li>
                                <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}">üö™ D√©connexion</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </nav>
            {% endif %}

            <!-- Contenu principal -->
            <main class="{% if current_user.is_authenticated %}col-md-10 offset-md-2{% else %}col-12{% endif %} main">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div id="flash-messages">
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- JS libs -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

        {% block scripts %}
        {{ moment.include_moment() }}
        {{ moment.locale('fr') }}
    {% endblock %}

    <script>
      // Auto-hide flash messages
      setTimeout(function() {
          document.querySelectorAll('.alert').forEach(function(el){
              let a = new bootstrap.Alert(el); a.close();
          });
      }, 5000);
    </script>

    <!-- PWA install button -->
    <button id="installBtn" hidden
            class="btn btn-outline-primary btn-sm position-fixed"
            style="right:1rem; bottom:1rem; z-index:1080;">
      Installer l‚Äôapp
    </button>

    <div id="updatePwa">Une mise √† jour est disponible <button id="reloadPwa">Mettre √† jour</button></div>

    <script>
    // SW + PWA install prompt + update bar
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(reg => {
        function showUpdate(registration) {
          const bar = document.getElementById('updatePwa');
          const btn = document.getElementById('reloadPwa');
          if (!bar || !btn) return;
          bar.style.display = 'inline-flex';
          btn.onclick = () => { registration.waiting?.postMessage({ type: 'SKIP_WAITING' }); };
        }
        if (reg.waiting) showUpdate(reg);
        reg.addEventListener('updatefound', () => {
          const sw = reg.installing;
          if (!sw) return;
          sw.addEventListener('statechange', () => {
            if (sw.state === 'installed' && reg.waiting) showUpdate(reg);
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => { window.location.reload(); });
      });

      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        const btn = document.getElementById('installBtn'); if (btn) btn.hidden = false;
      });
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('installBtn'); if (!btn) return;
        btn.addEventListener('click', async () => {
          btn.hidden = true;
          if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; }
          else { alert("Dans Edge : menu ‚ãØ ‚Üí Applications ‚Üí Installer ce site comme une application."); }
        });
      });
      window.addEventListener('appinstalled', () => { const btn = document.getElementById('installBtn'); if (btn) btn.hidden = true; });
    }
    </script>

    <style>
    /* Harmonise avec Bootstrap */
    .select2-container .select2-selection--single { height: 38px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 38px; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px; }
    </style>

    <!-- Charge Select2 UNE seule fois (avec bust cache pour le SW) -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js?v=4"></script>

    <script>
    // Init Select2 "classique" si tu utilises encore .select2 quelque part
    document.addEventListener('DOMContentLoaded', function () {
        $('.select2').select2({
        width: '100%',
        placeholder: 'Rechercher‚Ä¶',
        allowClear: true,
        language: 'fr'
        });
    });

    // Init Select2 AJAX robuste
    (function(){
        function initSelect2Ajax(ctx){
        const $ctx = $(ctx || document);

        if (typeof $.fn.select2 !== 'function') {
            console.error('Select2 non charg√©'); 
            return;
        }
        console.debug('[Select2] init select2-ajax dans', ctx === document ? 'document' : ctx);

        $ctx.find('.select2-ajax').each(function(){
            const $el = $(this);
            const ajaxUrl = $el.data('ajax_url');
            if (!ajaxUrl) { console.warn('select2-ajax sans data-ajax_url', this); return; }

            // Parent = modale si pr√©sente, sinon body (√©vite le dropdown cach√©)
            const $modal = $el.closest('.modal');
            const dropdownParent = $modal.length ? $modal : $(document.body);

            // D√©truit une √©ventuelle instance pr√©c√©dente pour √©viter les √©tats bizarres
            if ($el.hasClass('select2-hidden-accessible')) {
            try { $el.select2('destroy'); } catch(e){}
            }

            $el.select2({
            width: '100%',
            placeholder: ($el.data('placeholder') || 'Rechercher‚Ä¶'),
            allowClear: true,
            minimumInputLength: 1,   // Mets 1/0 pour tester; tu pourras repasser √† 2
            language: 'fr',
            ajax: {
                url: ajaxUrl,
                dataType: 'json',
                delay: 250,
                cache: true,
                data: params => ({ q: params.term || '', page: params.page || 1 }),
                processResults: (data) => ({
                results: (data && data.results) || [],
                pagination: { more: data && data.pagination && data.pagination.more }
                })
            },
            dropdownParent: dropdownParent
            });
        });
        }

        document.addEventListener('DOMContentLoaded', function(){
        initSelect2Ajax();
        // Si champs dans des modales => r√©-init √† l‚Äôouverture
        $(document).on('shown.bs.modal', function(e){ initSelect2Ajax(e.target); });
        // Focus auto sur la zone de recherche quand le menu s‚Äôouvre
        $(document).on('select2:open', () => {
            const inp = document.querySelector('.select2-container--open .select2-search__field');
            if (inp) inp.focus();
        });
        });
    })();
    </script>

</body>
</html>

